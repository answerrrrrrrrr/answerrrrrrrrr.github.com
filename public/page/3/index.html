<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Answerrrrrrrrr" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="なぜベストを尽くしたのか">
<meta property="og:type" content="website">
<meta property="og:title" content="Answerrrrrrrrr">
<meta property="og:url" content="http://answerrrrrrrrr.io/page/3/index.html">
<meta property="og:site_name" content="Answerrrrrrrrr">
<meta property="og:description" content="なぜベストを尽くしたのか">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Answerrrrrrrrr">
<meta name="twitter:description" content="なぜベストを尽くしたのか">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Answerrrrrrrrr </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Answerrrrrrrrr</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/19/Python-sorted函数中key的用法/" itemprop="url">
                  Python-sorted函数中key的用法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-19T09:02:08+08:00" content="2016-05-19">
              2016-05-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/19/Python-sorted函数中key的用法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/19/Python-sorted函数中key的用法/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>sorted函数的可用参数如下</p>
<blockquote>
<p>sorted(iterable[, cmp[, key[, reverse]]])</p>
</blockquote>
<p>其它几个还好理解，就是<code>key</code>的用法经常会忘记，所以记录一下备用</p>
<p><a href="http://devdocs.io/python~2.7/library/functions#sorted" target="_blank" rel="external">文档</a>中说：</p>
<blockquote>
<p>key specifies a function of one argument that is used to extract a comparison key from each list element: key=str.lower. The default value is None (compare the elements directly).</p>
</blockquote>
<p>我的理解是<br><code>key</code>提供了一个函数，以<code>iterable</code>对象中的元素为唯一参数，返回一个与原元素一一对应的 key 值<br>然后再对以这些 key 值为元素的<code>iterable</code>进行排序<br>最后将这些 key 值替换回对应的原元素<br>排序完成</p>
<p>需要注意的就是<code>False &lt; True</code></p>
<p>然后是实例（参考<a href="https://segmentfault.com/q/1010000005111826/a-1020000005112829）" target="_blank" rel="external">https://segmentfault.com/q/1010000005111826/a-1020000005112829）</a></p>
<figure class="highlight py"><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line">s = <span class="string">'aB23'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sorted_with_key</span><span class="params">(s, key)</span>:</span></div><div class="line">    s = sorted(s, key=key)</div><div class="line">    <span class="keyword">print</span> s</div><div class="line">    <span class="keyword">print</span> <span class="string">'keys: '</span>,</div><div class="line">    <span class="keyword">print</span> [key(x) <span class="keyword">for</span> x <span class="keyword">in</span> s]</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">'\nstr.lower'</span></div><div class="line">sorted_with_key(s, str.lower)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">'\nstr.islower'</span></div><div class="line">sorted_with_key(s, str.islower)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">'\nlambda x: x.isdigit() and int(x) % 2 == 0'</span></div><div class="line">sorted_with_key(s, <span class="keyword">lambda</span> x: x.isdigit() <span class="keyword">and</span> int(x) % <span class="number">2</span> == <span class="number">0</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">'\nlambda x: x.isdigit(), x.isdigit() and int(x) % 2==0, x.isupper(), x.islower(), x'</span></div><div class="line"><span class="comment"># 排序:小写-大写-奇数-偶数</span></div><div class="line">sorted_with_key(s, <span class="keyword">lambda</span> x: (x.isdigit(), x.isdigit() <span class="keyword">and</span> int(x) %</div><div class="line">                              <span class="number">2</span> == <span class="number">0</span>, x.isupper(), x.islower(), x))</div></pre></td></tr></table></figure>
<p>output</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"></div><div class="line">str.lower</div><div class="line">[<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'a'</span>, <span class="string">'B'</span>]</div><div class="line">keys:  [<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>]</div><div class="line"></div><div class="line">str.islower</div><div class="line">[<span class="string">'B'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'a'</span>]</div><div class="line">keys:  [<span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">True</span>]</div><div class="line"></div><div class="line"><span class="keyword">lambda</span> x: x.isdigit() <span class="keyword">and</span> int(x) % <span class="number">2</span> == <span class="number">0</span></div><div class="line">[<span class="string">'a'</span>, <span class="string">'B'</span>, <span class="string">'3'</span>, <span class="string">'2'</span>]</div><div class="line">keys:  [<span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">True</span>]</div><div class="line"></div><div class="line"><span class="keyword">lambda</span> x: (x.isdigit(), x.isdigit() <span class="keyword">and</span> int(x) % <span class="number">2</span>==<span class="number">0</span>, x.isupper(), x.islower(), x)</div><div class="line">[<span class="string">'a'</span>, <span class="string">'B'</span>, <span class="string">'3'</span>, <span class="string">'2'</span>]</div><div class="line">keys:  [(<span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">True</span>, <span class="string">'a'</span>), (<span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">True</span>, <span class="keyword">False</span>, <span class="string">'B'</span>), (<span class="keyword">True</span>, <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="string">'3'</span>), (<span class="keyword">True</span>, <span class="keyword">True</span>, <span class="keyword">False</span>, <span class="keyword">False</span>, <span class="string">'2'</span>)]</div></pre></td></tr></table></figure>
<h1 id="2016-7-9-补充"><a href="#2016-7-9-补充" class="headerlink" title="2016.7.9 补充"></a>2016.7.9 补充</h1><p>今天看了 cookbook 5.2，Python 2.4 之前是不支持<code>key</code>的，书中提供了一个类似的思路，感觉对理解<code>key</code>的实现很有帮助，摘录如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">case_insensitive_sorted</span><span class="params">(string_list)</span>:</span></div><div class="line">    auxiliary_list = [(x.lower(), x) <span class="keyword">for</span> x <span class="keyword">in</span> string_list] <span class="comment"># decorate</span></div><div class="line">    auxiliary_list.sort()                                  <span class="comment"># sort</span></div><div class="line">    <span class="keyword">return</span> [x[<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> auxiliary_list]                  <span class="comment"># undecorate</span></div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/16/Flask-数据库更新问题/" itemprop="url">
                  Flask 数据库更新问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-16T21:52:45+08:00" content="2016-05-16">
              2016-05-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Flask/" itemprop="url" rel="index">
                    <span itemprop="name">Flask</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/16/Flask-数据库更新问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/16/Flask-数据库更新问题/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="更新列"><a href="#更新列" class="headerlink" title="更新列"></a>更新列</h1><h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>学习到 8.4.6 测试登录时</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><div class="line">(venv) $ python manage<span class="selector-class">.py</span> shell </div><div class="line">&gt;&gt;&gt; u = User(email=<span class="string">'john@example.com'</span>, username=<span class="string">'john'</span>, password=<span class="string">'cat'</span>) </div><div class="line">&gt;&gt;&gt; db<span class="selector-class">.session</span><span class="selector-class">.add</span>(u) </div><div class="line">&gt;&gt;&gt; db<span class="selector-class">.session</span><span class="selector-class">.commit</span>()</div></pre></td></tr></table></figure>
<p>报错说表中无 email 列</p>
<p>确认代码无误后，判断应该是没有成功更新 models.py 中新建的 email 列，简单尝试无果，决定重新看一遍相关内容加深理解，再着手解决</p>
<h2 id="粗暴的更新方法"><a href="#粗暴的更新方法" class="headerlink" title="粗暴的更新方法"></a>粗暴的更新方法</h2><p>如果数据库表已经存在于数据库中， 那么 db.create_all() 不会重新创建或者更新这个表。如果修改模型后要把改动应用到现有的数据库中，这一特 性会带来不便。更新现有数据库表的粗暴方式是先删除旧表再重新创建：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;</span>&gt; db.drop_all() </div><div class="line"><span class="meta">&gt;&gt;</span>&gt; db.create_all()</div></pre></td></tr></table></figure>
<h2 id="使用-Flask-Migrate-实现数据库迁移"><a href="#使用-Flask-Migrate-实现数据库迁移" class="headerlink" title="使用 Flask-Migrate 实现数据库迁移"></a>使用 Flask-Migrate 实现数据库迁移</h2><blockquote>
<p>更新表的更好方法是使用数据库迁移框架。源码版本控制工具可以跟踪源码文件的变化， 类似地，数据库迁移框架能跟踪数据库模式的变化，然后增量式的把变化应用到数据库中。</p>
<p>SQLAlchemy 的主力开发人员编写了一个迁移框架，称为 Alembic（<a href="https://alembic.readthedocs" target="_blank" rel="external">https://alembic.readthedocs</a>. org/en/latest/index.html） 。 除 了 直 接 使 用 Alembic 之 外， Flask 程 序 还 可 使 用 Flask-Migrate （<a href="http://flask-migrate.readthedocs.org/en/latest/）扩展。这个扩展对" target="_blank" rel="external">http://flask-migrate.readthedocs.org/en/latest/）扩展。这个扩展对</a> Alembic 做了轻量级包装，并 集成到 Flask-Script 中，所有操作都通过 Flask-Script 命令完成。</p>
</blockquote>
<p>安装与配置略过不提<br>几次尝试后，方才对几个主要命令的实际作用有了正确的理解</p>
<h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><p>创建迁移仓库和脚本，并不会生成或更新数据库文件，<code>migrations/versions/</code>中为空，如果此时<code>upgrade</code>会生成一个只包含<code>alembic_version</code>表的数据库</p>
<figure class="highlight gams"><table><tr><td class="code"><pre><div class="line"><span class="symbol">$</span> sqlite3 data-dev.sqlite</div><div class="line">SQLite version <span class="number">3.8</span><span class="number">.10</span><span class="number">.2</span> <span class="number">2015</span><span class="number">-05</span><span class="number">-20</span> <span class="number">18</span>:<span class="number">17</span>:<span class="number">19</span></div><div class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> usage hints.</div><div class="line">sqlite&gt; .dump</div><div class="line">PRAGMA foreign_keys=OFF;</div><div class="line">BEGIN TRANSACTION;</div><div class="line">CREATE <span class="keyword">TABLE</span> alembic_version <span class="comment">(</span></div><div class="line">	version_num VARCHAR(<span class="number">32</span>) NOT NULL</div><div class="line">);</div><div class="line">COMMIT;</div><div class="line">sqlite&gt;</div></pre></td></tr></table></figure>
<h3 id="migrate"><a href="#migrate" class="headerlink" title="migrate"></a>migrate</h3><p>检测对数据库的操作，生成迁移脚本保存到<code>migrations/versions/</code>中，用于数据库迁移</p>
<p>不过按<a href="http://flask-migrate.readthedocs.io/en/latest/" target="_blank" rel="external">官方文档</a>所说，不一定能检测到所有对数据库的修改，所有需要自己对生成的迁移脚本进行检查，加上可能有遗漏的地方</p>
<h3 id="upgrade"><a href="#upgrade" class="headerlink" title="upgrade"></a>upgrade</h3><p>用于把上述迁移运用到数据库中，即至此才会真正对数据库进行更新</p>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><div class="line">$ sqlite3 data-dev.sqlite</div><div class="line">SQLite version 3.8.10.2 2015-05-20 18:17:19</div><div class="line">Enter ".help" for usage hints.</div><div class="line">sqlite&gt; .dump</div><div class="line">PRAGMA foreign_keys=OFF;</div><div class="line">BEGIN TRANSACTION;</div><div class="line"><span class="keyword">CREATE</span> TABLE alembic_version (</div><div class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"alembic_version"</span> <span class="keyword">VALUES</span>(<span class="string">'bb488872a057'</span>);</div><div class="line"><span class="keyword">CREATE</span> TABLE roles (</div><div class="line">	id INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	name VARCHAR(<span class="number">64</span>),</div><div class="line">	<span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id),</div><div class="line">	<span class="keyword">UNIQUE</span> (name)</div><div class="line">);</div><div class="line"><span class="keyword">CREATE</span> TABLE users (</div><div class="line">	id INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	email VARCHAR(<span class="number">64</span>),</div><div class="line">	username VARCHAR(<span class="number">64</span>),</div><div class="line">	role_id INTEGER,</div><div class="line">	password_hash VARCHAR(<span class="number">128</span>),</div><div class="line">	<span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id),</div><div class="line">	FOREIGN <span class="keyword">KEY</span>(role_id) REFERENCES roles (id)</div><div class="line">);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> ix_users_email <span class="keyword">ON</span> users (email);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> ix_users_username <span class="keyword">ON</span> users (username);</div><div class="line">COMMIT;</div><div class="line">sqlite&gt;</div></pre></td></tr></table></figure>
<h1 id="管理员角色"><a href="#管理员角色" class="headerlink" title="管理员角色"></a>管理员角色</h1><h2 id="遇到的问题-1"><a href="#遇到的问题-1" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>学习到 10.3.2后，发现以管理员邮箱注册的帐号并不能打开<code>管理员级别的资料编辑器</code><br>手动查看数据库：<br><figure class="highlight sql"><table><tr><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"users"</span> <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'huamingrui@163.com'</span>,<span class="string">'huamingrui'</span>,<span class="literal">NULL</span>,<span class="string">'pbkdf2:sha1:1000$wpqGMEz8$a3bf86fcb0be120a7510a8f702077eb2fdfa1980'</span>,<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="string">'2016-05-17 14:17:48.930851'</span>,<span class="string">'2016-05-17 14:19:00.735339'</span>);</div></pre></td></tr></table></figure></p>
<p>发现<code>role_id</code>项为空，即角色没有被成功赋予</p>
<h2 id="Role-insert-roles"><a href="#Role-insert-roles" class="headerlink" title="Role.insert_roles()"></a>Role.insert_roles()</h2><p>回去翻书，找到 9.3 最后的部分说到</p>
<blockquote>
<p>在你阅读下一章之前，最好重新创建或者更新开发数据库，如此一来，那些在实现角色和 权限之前创建的用户账户就被赋予了角色。</p>
</blockquote>
<p>然而实测发现，对于管理员用户，必须在注册之前就完成 9.1 最后的<code>Role.insert_roles()</code>步骤，才能成功为管理员邮箱用户赋予<code>管理员角色</code></p>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><div class="line">$ rm data-dev.sqlite</div><div class="line">$ python manage.py db upgrade</div><div class="line">INFO  [alembic.runtime.migration] Context impl SQLiteImpl.</div><div class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</div><div class="line">INFO  [alembic.runtime.migration] Running upgrade  -&gt; 02ccb3e6a553, empty message</div><div class="line">$ sqlite3 data-dev.sqlite</div><div class="line">SQLite version 3.8.10.2 2015-05-20 18:17:19</div><div class="line">Enter ".help" for usage hints.</div><div class="line">sqlite&gt; .dump</div><div class="line">PRAGMA foreign_keys=OFF;</div><div class="line">BEGIN TRANSACTION;</div><div class="line"><span class="keyword">CREATE</span> TABLE alembic_version (</div><div class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"alembic_version"</span> <span class="keyword">VALUES</span>(<span class="string">'02ccb3e6a553'</span>);</div><div class="line"><span class="keyword">CREATE</span> TABLE roles (</div><div class="line">	id INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	name VARCHAR(<span class="number">64</span>),</div><div class="line">	<span class="string">"default"</span> <span class="keyword">BOOLEAN</span>,</div><div class="line">	permissions INTEGER,</div><div class="line">	<span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id),</div><div class="line">	<span class="keyword">UNIQUE</span> (name),</div><div class="line">	CHECK (<span class="string">"default"</span> <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">);</div><div class="line"><span class="keyword">CREATE</span> TABLE users (</div><div class="line">	id INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	email VARCHAR(<span class="number">64</span>),</div><div class="line">	username VARCHAR(<span class="number">64</span>),</div><div class="line">	role_id INTEGER,</div><div class="line">	password_hash VARCHAR(<span class="number">128</span>),</div><div class="line">	confirmed <span class="keyword">BOOLEAN</span>,</div><div class="line">	name VARCHAR(<span class="number">64</span>),</div><div class="line">	location VARCHAR(<span class="number">64</span>),</div><div class="line">	about_me TEXT,</div><div class="line">	member_since DATETIME,</div><div class="line">	last_seen DATETIME,</div><div class="line">	<span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id),</div><div class="line">	FOREIGN <span class="keyword">KEY</span>(role_id) REFERENCES roles (id),</div><div class="line">	CHECK (confirmed <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> ix_roles_default <span class="keyword">ON</span> roles (<span class="string">"default"</span>);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> ix_users_email <span class="keyword">ON</span> users (email);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> ix_users_username <span class="keyword">ON</span> users (username);</div><div class="line">COMMIT;</div><div class="line">sqlite&gt; ^D</div><div class="line">$ python manage.py shell</div><div class="line">&gt;&gt;&gt; Role.insert_roles()</div><div class="line">&gt;&gt;&gt; Role.query.all()</div><div class="line">[&lt;Role u'Moderator'&gt;, &lt;Role u'Administrator'&gt;, &lt;Role u'User'&gt;]</div><div class="line">&gt;&gt;&gt; ^D</div><div class="line">$ sqlite3 data-dev.sqlite</div><div class="line">SQLite version 3.8.10.2 2015-05-20 18:17:19</div><div class="line">Enter ".help" for usage hints.</div><div class="line">sqlite&gt; .dump</div><div class="line">PRAGMA foreign_keys=OFF;</div><div class="line">BEGIN TRANSACTION;</div><div class="line"><span class="keyword">CREATE</span> TABLE alembic_version (</div><div class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"alembic_version"</span> <span class="keyword">VALUES</span>(<span class="string">'02ccb3e6a553'</span>);</div><div class="line"><span class="keyword">CREATE</span> TABLE roles (</div><div class="line">	id INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	name VARCHAR(<span class="number">64</span>),</div><div class="line">	<span class="string">"default"</span> <span class="keyword">BOOLEAN</span>,</div><div class="line">	permissions INTEGER,</div><div class="line">	<span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id),</div><div class="line">	<span class="keyword">UNIQUE</span> (name),</div><div class="line">	CHECK (<span class="string">"default"</span> <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"roles"</span> <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Moderator'</span>,<span class="number">0</span>,<span class="number">15</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"roles"</span> <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="string">'Administrator'</span>,<span class="number">0</span>,<span class="number">255</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"roles"</span> <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">'User'</span>,<span class="number">1</span>,<span class="number">7</span>);</div><div class="line"><span class="keyword">CREATE</span> TABLE users (</div><div class="line">	id INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	email VARCHAR(<span class="number">64</span>),</div><div class="line">	username VARCHAR(<span class="number">64</span>),</div><div class="line">	role_id INTEGER,</div><div class="line">	password_hash VARCHAR(<span class="number">128</span>),</div><div class="line">	confirmed <span class="keyword">BOOLEAN</span>,</div><div class="line">	name VARCHAR(<span class="number">64</span>),</div><div class="line">	location VARCHAR(<span class="number">64</span>),</div><div class="line">	about_me TEXT,</div><div class="line">	member_since DATETIME,</div><div class="line">	last_seen DATETIME,</div><div class="line">	<span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id),</div><div class="line">	FOREIGN <span class="keyword">KEY</span>(role_id) REFERENCES roles (id),</div><div class="line">	CHECK (confirmed <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> ix_roles_default <span class="keyword">ON</span> roles (<span class="string">"default"</span>);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> ix_users_email <span class="keyword">ON</span> users (email);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> ix_users_username <span class="keyword">ON</span> users (username);</div><div class="line">COMMIT;</div><div class="line">sqlite&gt; ^D</div><div class="line">$ python manage.py runserver</div></pre></td></tr></table></figure>
<p>注册管理员邮箱<br><figure class="highlight n1ql"><table><tr><td class="code"><pre><div class="line">$ sqlite3 data-dev.sqlite</div><div class="line">SQLite version 3.8.10.2 2015-05-20 18:17:19</div><div class="line">Enter ".help" for usage hints.</div><div class="line">sqlite&gt; .dump</div><div class="line">PRAGMA foreign_keys=OFF;</div><div class="line">BEGIN TRANSACTION;</div><div class="line"><span class="keyword">CREATE</span> TABLE alembic_version (</div><div class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span></div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"alembic_version"</span> <span class="keyword">VALUES</span>(<span class="string">'02ccb3e6a553'</span>);</div><div class="line"><span class="keyword">CREATE</span> TABLE roles (</div><div class="line">	id INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	name VARCHAR(<span class="number">64</span>),</div><div class="line">	<span class="string">"default"</span> <span class="keyword">BOOLEAN</span>,</div><div class="line">	permissions INTEGER,</div><div class="line">	<span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id),</div><div class="line">	<span class="keyword">UNIQUE</span> (name),</div><div class="line">	CHECK (<span class="string">"default"</span> <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"roles"</span> <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Moderator'</span>,<span class="number">0</span>,<span class="number">15</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"roles"</span> <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="string">'Administrator'</span>,<span class="number">0</span>,<span class="number">255</span>);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"roles"</span> <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">'User'</span>,<span class="number">1</span>,<span class="number">7</span>);</div><div class="line"><span class="keyword">CREATE</span> TABLE users (</div><div class="line">	id INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">	email VARCHAR(<span class="number">64</span>),</div><div class="line">	username VARCHAR(<span class="number">64</span>),</div><div class="line">	role_id INTEGER,</div><div class="line">	password_hash VARCHAR(<span class="number">128</span>),</div><div class="line">	confirmed <span class="keyword">BOOLEAN</span>,</div><div class="line">	name VARCHAR(<span class="number">64</span>),</div><div class="line">	location VARCHAR(<span class="number">64</span>),</div><div class="line">	about_me TEXT,</div><div class="line">	member_since DATETIME,</div><div class="line">	last_seen DATETIME,</div><div class="line">	<span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (id),</div><div class="line">	FOREIGN <span class="keyword">KEY</span>(role_id) REFERENCES roles (id),</div><div class="line">	CHECK (confirmed <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</div><div class="line">);</div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"users"</span> <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'huamingrui@163.com'</span>,<span class="string">'MrHua'</span>,<span class="number">2</span>,<span class="string">'pbkdf2:sha1:1000$tSmBVC7j$6f3d994eb5b6b455347b56d3112a4cac26fc97e1'</span>,<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="string">'2016-05-17 14:34:36.781740'</span>,<span class="string">'2016-05-17 14:52:08.764862'</span>);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> ix_roles_default <span class="keyword">ON</span> roles (<span class="string">"default"</span>);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> ix_users_email <span class="keyword">ON</span> users (email);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">UNIQUE</span> <span class="keyword">INDEX</span> ix_users_username <span class="keyword">ON</span> users (username);</div><div class="line">COMMIT;</div><div class="line">sqlite&gt;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/13/SohuSpider/" itemprop="url">
                  SohuSpider
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-13T15:55:31+08:00" content="2016-04-13">
              2016-04-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/13/SohuSpider/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/13/SohuSpider/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><blockquote>
<p>请设计一个系统，自动完成对于手机搜狐(<a href="http://m.sohu.com/" target="_blank" rel="external">http://m.sohu.com/</a> )系统可靠性的检测。具体要求：  </p>
<ol>
<li>定时递归检测所有m.sohu.com域名的页面以及这些页面上的链接的可达性，即有没有出现不可访问情况。  </li>
<li>m.sohu.com域名页面很多，从各个方面考虑性能优化。  </li>
<li>对于错误的链接记录到日志中，日志包括：连接，时间，错误状态等。  </li>
<li>考虑多线程的方式实现  </li>
</ol>
<p>要求：用Python实现，不使用爬取框架，一周内回复。</p>
</blockquote>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>因为之前才刚刚写了一个爬虫，本以为里面的线程池拿来就能用<br>结果昨天晚上大致改了个雏形出来，发觉爬到5分钟必定卡死，改了一晚上都没有解决<br>一怒之下 Google 了一记。。。<br>搜出来两位可能是去年实习的仁兄的答案，其中一位也是用的线程池，才意识到问题应该不在这里<br>抬头一看12点了，还突然停水不能洗脚。。。草草刷个牙郁闷地滚去睡了</p>
<p>今天学习了一下二位前辈的代码，彻底重写了一个，还是卡在5分钟，实在莫名其妙<br>Google 百度 各种改来改去无果，差点绝望了   </p>
<p>后来想到，没头绪的缘由还是因为卡住的时候连个报错都没有，没有好的切入点<br>那我就多加点 logger 好了</p>
<p>这才发现，5分钟的时候提取 URL 会出现大片的<code>None</code>，在这之前有个链接是 <a href="http://m.sohu.com/f/521204/?_once_=000067_ayy" target="_blank" rel="external">http://m.sohu.com/f/521204/?_once_=000067_ayy</a><br>手动打开的话会弹窗下载 搜狐新闻 apk<br>难道是因为这个原因导致 BeautifulSoup 提取不出来 href 了？</p>
<p>另外有个意外发现。。。<br>这回看见卡住了之后没有急着顺手 kill 掉<br>结果居然等了几分钟就好了。。。跑得那叫一个顺畅。。。<br>我也不知道这算什么情况了。。。   </p>
<p>把 crontab 的自动定时加上，这样大致算是完成了吧<br>明天再看看能做什么调整</p>
<p>还有论文没看呢。。。</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p><a href="https://github.com/answerrrrrrrrr/SohuSpider/blob/master/SohuSpider.py" target="_blank" rel="external">https://github.com/answerrrrrrrrr/SohuSpider/blob/master/SohuSpider.py</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://github.com/zhangity/sohu_crawled/blob/master/sohu1-5.py" target="_blank" rel="external">https://github.com/zhangity/sohu_crawled/blob/master/sohu1-5.py</a></li>
<li><a href="https://github.com/lan2720/deadurl_detector/blob/master/crawl.py#L2" target="_blank" rel="external">https://github.com/lan2720/deadurl_detector/blob/master/crawl.py#L2</a></li>
<li><a href="http://honglu.me/2014/09/20/OSX%E7%B3%BB%E7%BB%9F%E6%B7%BB%E5%8A%A0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" target="_blank" rel="external">http://honglu.me/2014/09/20/OSX%E7%B3%BB%E7%BB%9F%E6%B7%BB%E5%8A%A0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/08/Spider-07-doctest/" itemprop="url">
                  Spider-07-doctest
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-08T11:43:23+08:00" content="2016-04-08">
              2016-04-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/08/Spider-07-doctest/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/08/Spider-07-doctest/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第七天-doctest"><a href="#知道创宇爬虫设计第七天-doctest" class="headerlink" title="知道创宇爬虫设计第七天: doctest"></a>知道创宇爬虫设计第七天: doctest</h1><p><code>doctest</code>是 Python 内建的模块，用于文档测试，正好可以拿来用于爬虫的自测功能</p>
<p>这个模块相对简单，直接贴代码</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><table><tr><td class="code"><pre><div class="line">...</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">''' Prepare and run the spider</span></div><div class="line">    Self-test:</div><div class="line">    &gt;&gt;&gt; class Args(object):</div><div class="line">    ...     pass</div><div class="line">    ...</div><div class="line">    &gt;&gt;&gt; args = Args()</div><div class="line">    &gt;&gt;&gt; args.url = 'www.baidu.com'</div><div class="line">    &gt;&gt;&gt; args.depth = 1</div><div class="line">    &gt;&gt;&gt; args.logfile = 'testself.log'</div><div class="line">    &gt;&gt;&gt; args.loglevel = 4</div><div class="line">    &gt;&gt;&gt; args.dbfile = 'testself.db'</div><div class="line">    &gt;&gt;&gt; args.num_threads = 1</div><div class="line">    &gt;&gt;&gt; args.key = ''</div><div class="line">    &gt;&gt;&gt; set_logger(args.loglevel, args.logfile)</div><div class="line">    &gt;&gt;&gt; logger.info(vars(args))</div><div class="line">    &gt;&gt;&gt; spider = MySpider(args)</div><div class="line">    &gt;&gt;&gt; spider.run()</div><div class="line">    '''</div><div class="line">...</div><div class="line">    <span class="comment"># Self test</span></div><div class="line">    <span class="keyword">if</span> args.testself:</div><div class="line">        <span class="keyword">import</span> doctest</div><div class="line">        <span class="keyword">print</span> doctest.testmod()</div><div class="line">        <span class="keyword">return</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>另外其它部分也有少量修改，放在 <a href="https://github.com/answerrrrrrrrr/KnownsecSpider" target="_blank" rel="external">https://github.com/answerrrrrrrrr/KnownsecSpider</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014319170285543a4d04751f8846908770660de849f285000" target="_blank" rel="external">http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014319170285543a4d04751f8846908770660de849f285000</a></li>
<li><a href="http://devdocs.io/python~2.7/library/doctest#doctest.DocTest" target="_blank" rel="external">http://devdocs.io/python~2.7/library/doctest#doctest.DocTest</a></li>
<li><a href="http://devdocs.io/python~2.7/library/argparse#argparse.Namespace" target="_blank" rel="external">http://devdocs.io/python~2.7/library/argparse#argparse.Namespace</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/07/mysql-utf-8/" itemprop="url">
                  Mac 安装 MySQL 并设置 utf-8
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-07T22:23:29+08:00" content="2016-04-07">
              2016-04-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Mac/" itemprop="url" rel="index">
                    <span itemprop="name">Mac</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/07/mysql-utf-8/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/07/mysql-utf-8/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><p><a href="http://dev.mysql.com/downloads/mysql/5.6.html" target="_blank" rel="external">http://dev.mysql.com/downloads/mysql/5.6.html</a></p>
<h1 id="关闭服务"><a href="#关闭服务" class="headerlink" title="关闭服务"></a>关闭服务</h1><p><code>系统偏好设置 - MySQL - Stop MySQL Server</code></p>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ vim ~/.zshrc</div><div class="line"></div><div class="line">...</div><div class="line"># Add mysql</div><div class="line">export PATH=&quot;$PATH&quot;:/usr/local/mysql/bin</div><div class="line">...</div><div class="line"></div><div class="line">$ source ~/.zshrc</div></pre></td></tr></table></figure>
<h1 id="设置-utf-8"><a href="#设置-utf-8" class="headerlink" title="设置 utf-8"></a>设置 utf-8</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">$ sudo cp /usr/local/mysql/support-files/my-default.cnf /etc/my.cnf</div><div class="line">$ sudo vim /etc/my.cnf</div><div class="line"></div><div class="line">...</div><div class="line">[client]</div><div class="line">default-character-set = utf8</div><div class="line"></div><div class="line">[mysqld]</div><div class="line">default-storage-engine = INNODB</div><div class="line">character-set-server = utf8</div><div class="line">collation-server = utf8_general_ci</div><div class="line">...</div></pre></td></tr></table></figure>
<h1 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h1><p><code>系统偏好设置 - MySQL - Start MySQL Server</code></p>
<h1 id="验证-utf-8"><a href="#验证-utf-8" class="headerlink" title="验证 utf-8"></a>验证 utf-8</h1><figure class="highlight asciidoc"><table><tr><td class="code"><pre><div class="line">$ mysql -u root -p</div><div class="line">Enter password:</div><div class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</div><div class="line">Your MySQL connection id is 5</div><div class="line">Server version: 5.6.29 MySQL Community Server (GPL)</div><div class="line"></div><div class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</div><div class="line"></div><div class="line">Oracle is a registered trademark of Oracle Corporation and/or its</div><div class="line">affiliates. Other names may be trademarks of their respective</div><div class="line">owners.</div><div class="line"></div><div class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</div><div class="line"></div><div class="line"><span class="section">mysql&gt; show variables like '%char%';</span></div><div class="line">+--------------------------+--------------------------------------------------------+</div><div class="line"><span class="section">| Variable_name            | Value                                                  |</span></div><div class="line">+--------------------------+--------------------------------------------------------+</div><div class="line">| character<span class="emphasis">_set_</span>client     | utf8                                                   |</div><div class="line">| character<span class="emphasis">_set_</span>connection | utf8                                                   |</div><div class="line">| character<span class="emphasis">_set_</span>database   | utf8                                                   |</div><div class="line">| character<span class="emphasis">_set_</span>filesystem | binary                                                 |</div><div class="line">| character<span class="emphasis">_set_</span>results    | utf8                                                   |</div><div class="line">| character<span class="emphasis">_set_</span>server     | utf8                                                   |</div><div class="line">| character<span class="emphasis">_set_</span>system     | utf8                                                   |</div><div class="line"><span class="section">| character_sets_dir       | /usr/local/mysql-5.6.29-osx10.8-x86_64/share/charsets/ |</span></div><div class="line">+--------------------------+--------------------------------------------------------+</div><div class="line">8 rows in set (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt;</div></pre></td></tr></table></figure>
<h1 id="mysql-connector"><a href="#mysql-connector" class="headerlink" title="mysql.connector"></a>mysql.connector</h1><figure class="highlight smali"><table><tr><td class="code"><pre><div class="line">(venv3.5)$ pip3 install mysql-connector-python-rf</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014320107391860b39da6901ed41a296e574ed37104752000" target="_blank" rel="external">http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014320107391860b39da6901ed41a296e574ed37104752000</a></li>
<li><a href="http://blog.csdn.net/waleking/article/details/7620983" target="_blank" rel="external">http://blog.csdn.net/waleking/article/details/7620983</a></li>
<li><a href="http://jingyan.baidu.com/article/48a42057e2b2b9a9242504a2.html" target="_blank" rel="external">http://jingyan.baidu.com/article/48a42057e2b2b9a9242504a2.html</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/07/Spider-06-requests/" itemprop="url">
                  Spider-06-requests
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-07T19:53:43+08:00" content="2016-04-07">
              2016-04-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/07/Spider-06-requests/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/07/Spider-06-requests/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第六天：requests"><a href="#知道创宇爬虫设计第六天：requests" class="headerlink" title="知道创宇爬虫设计第六天：requests"></a>知道创宇爬虫设计第六天：requests</h1><p>从实验室回学校之后，仅仅是换了个网络，却突然出现了乱码问题</p>
<p>折腾了半天编码无果，无意中发现把<code>urllib2</code>换成<code>requests</code>就好了<br>按照<code>requests</code><a href="http://www.python-requests.org/en/master/user/quickstart/" target="_blank" rel="external">官方文档</a>里的解释</p>
<blockquote>
<p>When you make a request, Requests makes educated guesses about the encoding of the response based on the HTTP headers. The text encoding guessed by Requests is used when you access r.text.</p>
</blockquote>
<p>难怪总在知乎看见人安利，确实是更好用一些啊。。。</p>
<p>具体用法也很简单方便<br>不过使用<code>request.text</code>返回结果时，标题依然会乱码</p>
<blockquote>
<p>You can also access the response body as bytes, for non-text requests</p>
</blockquote>
<p>改成使用<code>request.content</code>，果然一切正常了</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><table><tr><td class="code"><pre><div class="line">...</div><div class="line">            <span class="comment"># request = urllib2.Request(url, headers=headers)</span></div><div class="line">            <span class="comment"># result = urllib2.urlopen(request).read()</span></div><div class="line"></div><div class="line">            request = requests.get(url, headers=headers)</div><div class="line">            <span class="comment"># result = request.text</span></div><div class="line">            result = request.content</div><div class="line">...</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.python-requests.org/en/master/" target="_blank" rel="external">http://www.python-requests.org/en/master/</a></li>
<li><a href="http://www.python-requests.org/en/master/user/quickstart/" target="_blank" rel="external">http://www.python-requests.org/en/master/user/quickstart/</a></li>
<li><a href="http://blog.csdn.net/alpha5/article/details/24964009" target="_blank" rel="external">http://blog.csdn.net/alpha5/article/details/24964009</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/06/Spider-05-Spider/" itemprop="url">
                  Spider-05-Spider
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-06T09:00:36+08:00" content="2016-04-06">
              2016-04-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/06/Spider-05-Spider/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/06/Spider-05-Spider/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第五天：Spider"><a href="#知道创宇爬虫设计第五天：Spider" class="headerlink" title="知道创宇爬虫设计第五天：Spider"></a>知道创宇爬虫设计第五天：Spider</h1><p> 准备工作完成的差不多了，今天尝试下把之前的模块都整合起来做一个初期版本</p>
<p> 首先 <a href="http://stackoverflow.com/questions/4327392/what-is-the-difference-between-web-crawling-and-web-scraping" target="_blank" rel="external">What is the difference between web-crawling and web-scraping?</a><br>感觉其实这个答案比最佳答案更简洁明了  </p>
<blockquote>
<p>Web Crawling is what Google does - it goes around a website looking at links and building a database of the layout of that site and sites it links to</p>
<p>Web Scraping would be the progamatic analysis of a web page to load some data off of it, EG loading up BBC weather and ripping (scraping) the weather forcast off of it and placing it elsewhere or using it in another program.</p>
</blockquote>
<p>我的理解就是<code>web-crawling</code>在于广度，<code>web-scraping</code>在于精度</p>
<h1 id="BeautifulSoup"><a href="#BeautifulSoup" class="headerlink" title="BeautifulSoup"></a>BeautifulSoup</h1><p>为了<code>crawl</code>，需要从页面提取出用于进一步爬取的 URL ，BeautifulSoup 正好能方便快捷地完成这个任务，上手也很简单，基本上看看<a href="http://beautifulsoup.readthedocs.org/zh_CN/latest/" target="_blank" rel="external">官方文档</a>就万事大吉了</p>
<h1 id="FileHandler"><a href="#FileHandler" class="headerlink" title="FileHandler"></a>FileHandler</h1><p>在整合 logger 的时候发现一个问题，使用<code>logging.config.fileConfig(&#39;logging.conf&#39;)</code>的话，需要提前在配置文件里写定日志保存路径，为了配合参数设定其他路径，似乎（看了一下 <a href="http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler" target="_blank" rel="external">FileHandler</a> 的用法）只能额外添加一个了</p>
<figure class="highlight clean"><table><tr><td class="code"><pre><div class="line">...</div><div class="line">    # If logfile is not <span class="string">'spider.log'</span></div><div class="line">    formatter = logging.Formatter(</div><div class="line">        <span class="string">'%(asctime)s - %(levelname)s - %(message)s'</span>)</div><div class="line">    file_handler.setFormatter(formatter)</div><div class="line">    logger.addHandler(file_handler)</div><div class="line">...</div></pre></td></tr></table></figure>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>目前爬虫已经基本能用，但偶尔还是会出现<code>502</code>，然后该往数据库里放些什么东西还有待考虑，另外也没有加上自测功能</p>
<figure class="highlight python"><figcaption><span>myspider.py</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</div><div class="line"><span class="keyword">from</span> Queue <span class="keyword">import</span> Queue</div><div class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</div><div class="line"><span class="keyword">import</span> urllib2</div><div class="line"><span class="keyword">import</span> argparse</div><div class="line"><span class="keyword">import</span> sqlite3</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> logging.config</div><div class="line"></div><div class="line"></div><div class="line">logging.config.fileConfig(<span class="string">'logging.conf'</span>)</div><div class="line">logger = logging.getLogger(<span class="string">'spider'</span>)</div><div class="line"></div><div class="line">levels = &#123;</div><div class="line">    <span class="number">1</span>: <span class="string">'CRITICAL'</span>,</div><div class="line">    <span class="number">2</span>: <span class="string">'ERROR'</span>,</div><div class="line">    <span class="number">3</span>: <span class="string">'WARNING'</span>,</div><div class="line">    <span class="number">4</span>: <span class="string">'INFO'</span>,</div><div class="line">    <span class="number">5</span>: <span class="string">'DEBUG'</span>,</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlite</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, dbfile)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            logger.warning(<span class="string">"Open database %s"</span> % dbfile)</div><div class="line">            self.conn = sqlite3.connect(dbfile)</div><div class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</div><div class="line">            <span class="comment"># print "Fail to connect %s: %s" % (dbfile, e) # e.args[0]</span></div><div class="line">            logger.error(<span class="string">"Fail to connect %s: %s"</span> % (dbfile, e))</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">        self.cursor = self.conn.cursor()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, table)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            logger.warning(<span class="string">"Create table %s if not exists"</span> % table)</div><div class="line">            self.cursor.execute(</div><div class="line">                <span class="string">"CREATE TABLE IF NOT EXISTS %s (id INTEGER PRIMARY KEY \</span></div><div class="line">                AUTOINCREMENT, url VARCHAR(100), data VARCHAR(40))" % table)</div><div class="line">            self.conn.commit()</div><div class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</div><div class="line">            logger.error(<span class="string">"Fail to create %s: %s"</span> % (table, e))</div><div class="line">            self.conn.rollback()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, table, url, data)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            logger.warning(</div><div class="line">                <span class="string">"Insert (%s, %s) into table %s"</span> % (url, data, table))</div><div class="line">            self.cursor.execute(</div><div class="line">                <span class="string">"INSERT INTO %s (url, data) VALUES ('%s', '%s')"</span> %</div><div class="line">                (table, url, data))</div><div class="line">            self.conn.commit()</div><div class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</div><div class="line">            logger.error(</div><div class="line">                <span class="string">"Fail to insert (%s, %s) into %s: %s"</span> %</div><div class="line">                (url, data, table, e))</div><div class="line">            self.conn.rollback()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></div><div class="line">        logger.info(<span class="string">"Close database"</span>)</div><div class="line">        self.cursor.close()</div><div class="line">        self.conn.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThreadPool</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, num_threads=<span class="number">10</span>)</span>:</span></div><div class="line">        self.tasks = Queue(num_threads)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, num_threads+<span class="number">1</span>):</div><div class="line">            <span class="comment"># Initialize the pool with the number of num_threads</span></div><div class="line">            logger.info(<span class="string">'Initialize thread %d'</span> % i)</div><div class="line">            MyThread(self.tasks)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_task</span><span class="params">(self, func, *args, **kwargs)</span>:</span></div><div class="line">        self.tasks.put((func, args, kwargs))</div><div class="line">        logger.debug(<span class="string">'Add task'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_completion</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># Blocks until all items in the queue have been gotten and processed.</span></div><div class="line">        self.tasks.join()</div><div class="line">        logger.info(<span class="string">'All tasks are done'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(Thread)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tasks)</span>:</span></div><div class="line">        Thread.__init__(self)</div><div class="line">        self.tasks = tasks</div><div class="line">        <span class="comment"># This must be set before start() is called. The entire Python program</span></div><div class="line">        <span class="comment"># exits when no alive non-daemon threads are left.</span></div><div class="line">        self.daemon = <span class="keyword">True</span></div><div class="line">        self.start()</div><div class="line">        logger.debug(<span class="string">'Thread started...'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            <span class="comment"># Block until an item is available.</span></div><div class="line">            func, args, kwargs = self.tasks.get()</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                logger.warning(<span class="string">'Thread is working...'</span>)</div><div class="line">                func(*args, **kwargs)</div><div class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                logger.error(e)</div><div class="line">            <span class="comment"># Tells the queue that the processing on the task is complete.</span></div><div class="line">            self.tasks.task_done()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySpider</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></div><div class="line">        <span class="string">''' Initialize the spider</span></div><div class="line">        '''</div><div class="line">        <span class="comment"># Initialize args</span></div><div class="line">        self.url = args.url</div><div class="line">        self.depth = args.depth</div><div class="line">        self.logfile = args.logfile</div><div class="line">        self.dbfile = args.dbfile</div><div class="line">        self.num_threads = args.num_threads</div><div class="line">        self.key = args.key.lower()</div><div class="line">        self.selftest = args.selftest</div><div class="line"></div><div class="line">        <span class="comment"># Store visited url</span></div><div class="line">        self.visited_urls = set()</div><div class="line"></div><div class="line">        <span class="comment"># Initialize threadpool</span></div><div class="line">        self.threadpool = MyThreadPool(self.num_threads)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">''' Run the spider</span></div><div class="line">        '''</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.url.startswith(<span class="string">'http://'</span>):</div><div class="line">            self.url = <span class="string">'http://'</span> + self.url</div><div class="line">        logger.critical(<span class="string">'Start crawl on %s'</span> % self.url)</div><div class="line">        self.threadpool.add_task(self.scrape, self.url, self.depth)</div><div class="line">        self.threadpool.wait_completion()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">scrape</span><span class="params">(self, url, depth)</span>:</span></div><div class="line">        <span class="string">''' Scrape the content of page</span></div><div class="line">        '''</div><div class="line">        <span class="comment"># Open database with dbfile</span></div><div class="line">        db = MySqlite(self.dbfile)</div><div class="line">        <span class="comment"># Create table with keyword</span></div><div class="line">        table = <span class="string">'none'</span> <span class="keyword">if</span> <span class="keyword">not</span> self.key <span class="keyword">else</span> self.key</div><div class="line">        db.create(table)</div><div class="line"></div><div class="line">        <span class="comment"># Avoid being recognized as robot</span></div><div class="line">        headers = &#123;</div><div class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) \</span></div><div class="line">            AppleWebKit/537.36 (KHTML, like Gecko) \</div><div class="line">            Chrome/49.0.2623.110 Safari/537.36'</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment"># Avoid repeat</span></div><div class="line">        <span class="keyword">if</span> url <span class="keyword">in</span> self.visited_urls:</div><div class="line">            logger.debug(<span class="string">'%s had been crawled'</span> % url)</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.visited_urls.add(url)</div><div class="line">            logger.info(<span class="string">'Crawling on %s'</span> % url)</div><div class="line"></div><div class="line">        <span class="comment"># Request with headers</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            logger.warning(<span class="string">'Open %s'</span> % url)</div><div class="line">            request = urllib2.Request(url, headers=headers)</div><div class="line">            result = urllib2.urlopen(request).read()</div><div class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</div><div class="line">            logger.error(e)</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">        <span class="comment"># Extract the title by BeautifulSoup</span></div><div class="line">        soup = BeautifulSoup(result, <span class="string">"lxml"</span>)</div><div class="line">        title = soup.title.string</div><div class="line">        logger.debug(<span class="string">'title = %s'</span> % title)</div><div class="line"></div><div class="line">        <span class="comment"># Store url and title of the page with keyword into database</span></div><div class="line">        <span class="keyword">if</span> self.key <span class="keyword">in</span> result.lower():</div><div class="line">            table = <span class="string">'none'</span> <span class="keyword">if</span> <span class="keyword">not</span> self.key <span class="keyword">else</span> self.key</div><div class="line">            db.insert(table, url, title)</div><div class="line">            logger.critical(</div><div class="line">                <span class="string">'KEYWORD:\'%s\' - URL:\'%s\' - TITLE:\'%s\' (DEPTH:%d)'</span> %</div><div class="line">                (self.key, url, title, depth))</div><div class="line"></div><div class="line">        <span class="comment"># Close database after modification</span></div><div class="line">        db.close()</div><div class="line"></div><div class="line">        <span class="comment"># Go deeper into urls in result</span></div><div class="line">        self.crawl(soup, depth<span class="number">-1</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(self, soup, depth)</span>:</span></div><div class="line">        <span class="string">''' Crawl to new pages</span></div><div class="line">        '''</div><div class="line">        <span class="keyword">if</span> depth &gt; <span class="number">0</span>:</div><div class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> soup.find_all(<span class="string">'a'</span>):</div><div class="line">                url = link.get(<span class="string">'href'</span>)</div><div class="line">                <span class="comment"># scrape new url</span></div><div class="line">                self.threadpool.add_task(self.scrape, url, depth)</div><div class="line"></div><div class="line">    <span class="comment"># def stop(self):</span></div><div class="line">    <span class="comment">#     ''' Stop the spider</span></div><div class="line">    <span class="comment">#     '''</span></div><div class="line">    <span class="comment">#     logger.critical('OVER')</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">args_parser</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">''' Parse the args</span></div><div class="line">    '''</div><div class="line">    parser = argparse.ArgumentParser()</div><div class="line"></div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'-u'</span>, <span class="string">'--url'</span>, dest=<span class="string">'url'</span>, required=<span class="keyword">True</span>,</div><div class="line">        help=<span class="string">'specify the URL to start crawl'</span></div><div class="line">    )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'-d'</span>, <span class="string">'--depth'</span>, dest=<span class="string">'depth'</span>, default=<span class="number">1</span>, type=int,</div><div class="line">        help=<span class="string">'specify the depth of the spider (default: 1)'</span></div><div class="line">    )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'-f'</span>, <span class="string">'--file'</span>, dest=<span class="string">'logfile'</span>, default=<span class="string">'spider.log'</span>,</div><div class="line">        help=<span class="string">'specify the path of logfile (default: spider.log)'</span></div><div class="line">    )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'-l'</span>, <span class="string">'--level'</span>, dest=<span class="string">'loglevel'</span>, default=<span class="number">5</span>, type=int,</div><div class="line">        choices=range(<span class="number">1</span>, <span class="number">6</span>),</div><div class="line">        help=<span class="string">'specify the verbose level of the log (default: 5)'</span></div><div class="line">    )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'--dbfile'</span>, dest=<span class="string">'dbfile'</span>, default=<span class="string">'spider.db'</span>,</div><div class="line">        help=<span class="string">'specify the path of sqlite dbfile (default: spider.db)'</span></div><div class="line">    )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'--thread'</span>, dest=<span class="string">'num_threads'</span>, default=<span class="number">10</span>, type=int,</div><div class="line">        help=<span class="string">'specify the size of thread pool (default: 10)'</span></div><div class="line">    )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'--key'</span>, dest=<span class="string">'key'</span>, default=<span class="string">''</span>,</div><div class="line">        help=<span class="string">'specify the keyword (default: '</span><span class="string">')'</span></div><div class="line">    )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'--selftest'</span>, action=<span class="string">'store_true'</span>,</div><div class="line">        help=<span class="string">'self-test'</span></div><div class="line">    )</div><div class="line"></div><div class="line">    args = parser.parse_args()</div><div class="line">    <span class="keyword">return</span> args</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_logger</span><span class="params">(loglevel, logfile)</span>:</span></div><div class="line">    <span class="string">''' Set the logger with loglevel and logfile</span></div><div class="line">    '''</div><div class="line">    logger.setLevel(levels[loglevel])</div><div class="line">    file_handler = logging.FileHandler(logfile)</div><div class="line"></div><div class="line">    <span class="comment"># If logfile is not 'spider.log'</span></div><div class="line">    formatter = logging.Formatter(</div><div class="line">        <span class="string">'%(asctime)s - %(levelname)s - %(message)s'</span>)</div><div class="line">    file_handler.setFormatter(formatter)</div><div class="line">    logger.addHandler(file_handler)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    args = args_parser()</div><div class="line">    set_logger(args.loglevel, args.logfile)</div><div class="line">    logger.debug(args)</div><div class="line"></div><div class="line">    spider = MySpider(args)</div><div class="line">    spider.run()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://beautifulsoup.readthedocs.org/zh_CN/latest/" target="_blank" rel="external">http://beautifulsoup.readthedocs.org/zh_CN/latest/</a></li>
<li><a href="http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler" target="_blank" rel="external">http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler</a></li>
<li><a href="http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/" target="_blank" rel="external">http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/Sublime-Packages/" itemprop="url">
                  Sublime Preferences
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-05T16:24:00+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sublime/" itemprop="url" rel="index">
                    <span itemprop="name">Sublime</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/Sublime-Packages/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/Sublime-Packages/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="切换标签页"><a href="#切换标签页" class="headerlink" title="切换标签页"></a>切换标签页</h1><p>首先，Sublime 的所谓「标签页智能切换」很蛋疼，改成通用快捷键设定</p>
<figure class="highlight js"><figcaption><span>Default (OSX).sublime-keymap</span></figcaption><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"keys"</span>: [<span class="string">"ctrl+tab"</span>],</div><div class="line">    <span class="string">"command"</span>: <span class="string">"next_view"</span></div><div class="line">&#125;,</div><div class="line">&#123;</div><div class="line">    <span class="string">"keys"</span>: [<span class="string">"ctrl+shift+tab"</span>],</div><div class="line">    <span class="string">"command"</span>: <span class="string">"prev_view"</span></div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<h1 id="Vintage"><a href="#Vintage" class="headerlink" title="Vintage"></a><a href="https://github.com/sublimehq/Vintage" target="_blank" rel="external">Vintage</a></h1><p>这个是Sublime自带的vi模式<br>先注释掉<code>Preferences.sublime-settings</code>里的<code>Vintage</code></p>
<figure class="highlight js"><figcaption><span>Preferences.sublime-settings</span></figcaption><table><tr><td class="code"><pre><div class="line">...</div><div class="line">    <span class="string">"ignored_packages"</span>:[</div><div class="line">        <span class="comment">// "Vintage"</span></div><div class="line">    ],</div><div class="line">...</div></pre></td></tr></table></figure>
<p>再按照习惯把<code>esc</code>改成<code>j</code> <code>j</code></p>
<figure class="highlight js"><figcaption><span>Default (OSX).sublime-keymap</span></figcaption><table><tr><td class="code"><pre><div class="line">...</div><div class="line"><span class="comment">// Vintage</span></div><div class="line">    &#123;</div><div class="line">        <span class="string">"keys"</span>: [<span class="string">"j"</span>, <span class="string">"j"</span>],</div><div class="line">        <span class="string">"command"</span>: <span class="string">"exit_insert_mode"</span>,</div><div class="line">        <span class="string">"context"</span>:[</div><div class="line">            &#123;</div><div class="line">                <span class="string">"key"</span>: <span class="string">"setting.command_mode"</span>,</div><div class="line">                <span class="string">"operand"</span>: <span class="literal">false</span></div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                <span class="string">"key"</span>: <span class="string">"setting.is_widget"</span>,</div><div class="line">                <span class="string">"operand"</span>: <span class="literal">false</span></div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<p>另外还有一个<a href="https://github.com/SublimeText/VintageEx" target="_blank" rel="external">VintageEx</a>，不过我倒是没有太大需求</p>
<h1 id="SublimeREPL"><a href="#SublimeREPL" class="headerlink" title="SublimeREPL"></a><a href="https://github.com/wuub/SublimeREPL" target="_blank" rel="external">SublimeREPL</a></h1><p>无意中发现一个类似 Vim 下 quickrun 的插件<code>SublimeREPL</code></p>
<p>在<code>Perferences</code>-<code>Key Bindings - User</code>中加入</p>
<figure class="highlight js"><figcaption><span>Default (OSX).sublime-keymap</span></figcaption><table><tr><td class="code"><pre><div class="line">...</div><div class="line">    <span class="comment">// SublimeREPL - Python</span></div><div class="line">    &#123;</div><div class="line">        <span class="string">"keys"</span>: [<span class="string">"f2"</span>],</div><div class="line">        <span class="string">"caption"</span>: <span class="string">"SublimeREPL: Python - RUN current file"</span>,</div><div class="line">        <span class="string">"command"</span>: <span class="string">"run_existing_window_command"</span>,</div><div class="line">        <span class="string">"args"</span>: &#123;</div><div class="line">            <span class="string">"id"</span>: <span class="string">"repl_python_run"</span>,</div><div class="line">            <span class="string">"file"</span>: <span class="string">"config/Python/Main.sublime-menu"</span>,</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<p>这样一来，保存之后按<code>F2</code>即可快速运行 Python 脚本，不用来回切换终端了<br>C’est bon!</p>
<h1 id="ExpandRegion"><a href="#ExpandRegion" class="headerlink" title="ExpandRegion"></a><a href="https://github.com/aronwoost/sublime-expand-region" target="_blank" rel="external">ExpandRegion</a></h1><p>在<a href="https://www.zhihu.com/question/24896283" target="_blank" rel="external">知乎</a>看到推荐感觉挺不错，用于快速扩展选区，也是在<code>Perferences</code>-<code>Key Bindings - User</code>中加入</p>
<figure class="highlight js"><figcaption><span>Default (OSX).sublime-keymap</span></figcaption><table><tr><td class="code"><pre><div class="line">...</div><div class="line">    &#123;</div><div class="line">        <span class="string">"keys"</span>: [<span class="string">"super+e"</span>],</div><div class="line">        <span class="string">"command"</span>: <span class="string">"expand_region"</span></div><div class="line">    &#125;,</div><div class="line">    &#123;</div><div class="line">        <span class="string">"keys"</span>: [<span class="string">"super+u"</span>],</div><div class="line">        <span class="string">"command"</span>: <span class="string">"expand_region"</span>,</div><div class="line">        <span class="string">"args"</span>: &#123;</div><div class="line">            <span class="string">"undo"</span>: <span class="literal">true</span></div><div class="line">        &#125;,</div><div class="line">        <span class="string">"context"</span>: [</div><div class="line">            &#123;</div><div class="line">                <span class="string">"key"</span>: <span class="string">"expand_region_soft_undo"</span></div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<h1 id="Anaconda"><a href="#Anaconda" class="headerlink" title="Anaconda"></a><a href="https://github.com/DamnWidget/anaconda" target="_blank" rel="external">Anaconda</a></h1><p>这个插件确实强大，不过有点小问题</p>
<h2 id="import-时不能自动补全"><a href="#import-时不能自动补全" class="headerlink" title="import 时不能自动补全"></a>import 时不能自动补全</h2><p>在<a href="https://github.com/DamnWidget/anaconda/issues/89" target="_blank" rel="external">Stackoverflow</a>找到解决方案<br>新建<code>/Users/air9/Library/Application\ Support/Sublime\ Text\ 3/Packages/Python/Completion\ Rules.tmPreferences</code>并加入如下内容</p>
<figure class="highlight xml"><figcaption><span>Completion Rules.tmPreferences</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>scope<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>source.python<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>settings<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dict</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>cancelCompletion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>^(.*\b(and|or)$)|(\s*(pass|return|and|or|(class|def)\s*[a-zA-Z_0-9]+)$)<span class="tag">&lt;/<span class="name">string</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></div></pre></td></tr></table></figure>
<p>保存后重启 Sublime 即可</p>
<p><strong>不过第一次弄的时候，不知道怎么回事出现了配置文件被初始化的 bug，所有插件和改键都失效了。。。还好我碰巧刚刚做了备份，所以下次也要记得先备份一下</strong></p>
<h2 id="过于频繁的补全弹窗"><a href="#过于频繁的补全弹窗" class="headerlink" title="过于频繁的补全弹窗"></a>过于频繁的补全弹窗</h2><p>随便按一个空格就以<code>a</code>开头弹窗提示我补全，有时甚至回车补全完成之后弹窗仍然消失不掉，一怒之下禁用掉了</p>
<figure class="highlight js"><figcaption><span>Anaconda.sublime-settings</span></figcaption><table><tr><td class="code"><pre><div class="line">...</div><div class="line">    <span class="comment">/*</span></div><div class="line">        Disable anaconda completion</div><div class="line"></div><div class="line">        WARNING: set this as true will totally disable anaconda completion</div><div class="line">    */</div><div class="line">    <span class="comment">// "disable_anaconda_completion": false,</span></div><div class="line">    <span class="string">"disable_anaconda_completion"</span>: <span class="literal">true</span>,</div><div class="line"></div><div class="line">    <span class="comment">/*</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>Sublime 自带的轻量级补全其实已经满足我的日常需求了，装 Anaconda 主要还是为了 Tooltip 和 PEP8 提示</p>
<h1 id="MarkdownEditing"><a href="#MarkdownEditing" class="headerlink" title="MarkdownEditing"></a><a href="https://github.com/SublimeText-Markdown/MarkdownEditing" target="_blank" rel="external">MarkdownEditing</a></h1><p>这个其实用处不大，平常在 Mac 上写 Markdown 都用的 MacDown<br>不过默认会渲染 txt 还是挺蛋疼的，注释掉<br>顺便改个主题</p>
<figure class="highlight js"><figcaption><span>Markdown.sublime-settings</span></figcaption><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"extensions"</span>:</div><div class="line">    [</div><div class="line">        <span class="string">"md"</span>,</div><div class="line">        <span class="string">"mdown"</span>,</div><div class="line">        <span class="comment">// "txt"</span></div><div class="line">    ],</div><div class="line"></div><div class="line">    <span class="string">"color_scheme"</span>: <span class="string">"Packages/MarkdownEditing/MarkdownEditor-Dark.tmTheme"</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/Spider-04-sqlite/" itemprop="url">
                  Spider-04-sqlite3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-05T09:39:06+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/Spider-04-sqlite/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/Spider-04-sqlite/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第四天：sqlite3"><a href="#知道创宇爬虫设计第四天：sqlite3" class="headerlink" title="知道创宇爬虫设计第四天：sqlite3"></a>知道创宇爬虫设计第四天：sqlite3</h1><p>这部分比较简单，需要注意的几点</p>
<ul>
<li>connect, cursor</li>
<li>execute</li>
<li>commit, rollback</li>
<li>close</li>
</ul>
<p>既然之前已经学会了使用logging，就可以尝试下配合着使用</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><figcaption><span>MySqlite.py</span></figcaption><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> sqlite3</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> logging.config</div><div class="line">logging.config.fileConfig(<span class="string">'logging.conf'</span>)</div><div class="line"></div><div class="line"></div><div class="line">levels = &#123;</div><div class="line">    <span class="number">1</span>: <span class="string">'CRITICAL'</span>,</div><div class="line">    <span class="number">2</span>: <span class="string">'ERROR'</span>,</div><div class="line">    <span class="number">3</span>: <span class="string">'WARNING'</span>,</div><div class="line">    <span class="number">4</span>: <span class="string">'INFO'</span>,</div><div class="line">    <span class="number">5</span>: <span class="string">'DEBUG'</span>,</div><div class="line">&#125;</div><div class="line">loglevel = <span class="number">4</span></div><div class="line">logger = logging.getLogger(<span class="string">'spider'</span>)</div><div class="line">logger.setLevel(levels[loglevel])</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlite</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, dbfile)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.conn = sqlite3.connect(dbfile)</div><div class="line">            logger.info(<span class="string">"Open database %s"</span> % dbfile)</div><div class="line">            logger.debug(<span class="string">"Open database %s"</span> % dbfile)</div><div class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</div><div class="line">            <span class="comment"># print "Fail to connect %s: %s" % (dbfile, e) # e.args[0]</span></div><div class="line">            logger.error(<span class="string">"Fail to connect %s: %s"</span> % (dbfile, e))</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">        self.cursor = self.conn.cursor()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, table)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            logger.info(<span class="string">"Create table %s"</span> % table)</div><div class="line">            self.cursor.execute(</div><div class="line">                <span class="string">"CREATE TABLE IF NOT EXISTS %s(Id INTEGER PRIMARY KEY \</span></div><div class="line">                AUTOINCREMENT, Data VARCHAR(40))" % table</div><div class="line">                )</div><div class="line">            self.conn.commit()</div><div class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</div><div class="line">            logger.error(<span class="string">"Fail to create %s: %s"</span> % (table, e))</div><div class="line">            self.conn.rollback()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, table, data)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            logger.info(<span class="string">"Insert %s into table %s"</span> % (data, table))</div><div class="line">            self.cursor.execute(</div><div class="line">                <span class="string">"INSERT INTO %s(Data) VALUES('%s')"</span> % (table, data))</div><div class="line">            self.conn.commit()</div><div class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</div><div class="line">            logger.error(<span class="string">"Fail to insert %s into %s: %s"</span> % (data, table, e))</div><div class="line">            self.conn.rollback()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></div><div class="line">        logger.info(<span class="string">"Close database"</span>)</div><div class="line">        self.cursor.close()</div><div class="line">        self.conn.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    ms = MySqlite(<span class="string">'spider.db'</span>)</div><div class="line">    ms.create(<span class="string">'t1'</span>)</div><div class="line">    ms.insert(<span class="string">'t1'</span>, <span class="string">'test'</span>)</div><div class="line">    ms.close()</div></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>logging.conf</span></figcaption><table><tr><td class="code"><pre><div class="line">[loggers]</div><div class="line">keys = root, spider</div><div class="line"></div><div class="line">[handlers]</div><div class="line">keys = consoleHandler, fileHandler</div><div class="line"></div><div class="line">[formatters]</div><div class="line">keys = simpleFormatter</div><div class="line"></div><div class="line">[logger_root]</div><div class="line">level = DEBUG</div><div class="line">handlers = consoleHandler</div><div class="line"></div><div class="line">[logger_spider]</div><div class="line">level = DEBUG</div><div class="line">handlers = consoleHandler, fileHandler</div><div class="line">qualname = spider</div><div class="line">propagate = 0</div><div class="line"></div><div class="line">[handler_consoleHandler]</div><div class="line">class = StreamHandler</div><div class="line">level = DEBUG</div><div class="line">formatter = simpleFormatter</div><div class="line">args = (sys.stdout,)</div><div class="line"></div><div class="line">[handler_fileHandler]</div><div class="line">class = FileHandler</div><div class="line">level = DEBUG</div><div class="line">formatter = simpleFormatter</div><div class="line">args = (&apos;spider.log&apos;, &apos;w&apos;)</div><div class="line"></div><div class="line">[formatter_simpleFormatter]</div><div class="line">format = %(asctime)s - %(name)s - %(levelname)s - %(message)s</div><div class="line">datefmt =</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://docs.python.org/2/library/sqlite3.html" target="_blank" rel="external">https://docs.python.org/2/library/sqlite3.html</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_72603eac01013pbc.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_72603eac01013pbc.html</a></li>
<li><a href="http://blog.csdn.net/jeepxiaozi/article/details/8808435" target="_blank" rel="external">http://blog.csdn.net/jeepxiaozi/article/details/8808435</a></li>
<li><a href="http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/" target="_blank" rel="external">http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/</a></li>
<li><a href="http://devdocs.io/python~2.7/library/logging.config" target="_blank" rel="external">http://devdocs.io/python~2.7/library/logging.config</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/04/Spider-03-argparse/" itemprop="url">
                  Spider-03-argparse
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-04T15:39:12+08:00" content="2016-04-04">
              2016-04-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/04/Spider-03-argparse/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/04/Spider-03-argparse/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第三天：argparse"><a href="#知道创宇爬虫设计第三天：argparse" class="headerlink" title="知道创宇爬虫设计第三天：argparse"></a>知道创宇爬虫设计第三天：argparse</h1><p>题目原本是2012年的，要求的optparse模块已经过时，因此按照argparse来学习</p>
<p>提取要点如下：</p>
<ul>
<li><code>class argparse.ArgumentParser(prog=None, usage=None, description=None, epilog=None, parents=[], formatter_class=argparse.HelpFormatter, prefix_chars=&#39;-&#39;, fromfile_prefix_chars=None, argument_default=None, conflict_handler=&#39;error&#39;, add_help=True)</code></li>
<li><code>ArgumentParser.add_argument(name or flags...[, action][, nargs][, const][, default][, type][, choices][, required][, help][, metavar][, dest])</code></li>
<li>ArgumentParser通过parse_args()方法解析参数。它将检查命令行，把每个参数转换成恰当的类型并采取恰当的动作。在大部分情况下，这意味着将从命令行中解析出来的属性建立一个简单的 Namespace对象</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><table><tr><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> argparse</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">()</span>:</span></div><div class="line">    parser = argparse.ArgumentParser()</div><div class="line"></div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'-u'</span>, <span class="string">'--url'</span>, dest=<span class="string">'url'</span>, required=<span class="keyword">True</span>,</div><div class="line">        help=<span class="string">'specify the URL to start crawl'</span></div><div class="line">        )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'-d'</span>, <span class="string">'--depth'</span>, dest=<span class="string">'depth'</span>,</div><div class="line">        default=<span class="number">1</span>, type=int,</div><div class="line">        help=<span class="string">'specify the depth of the spider (default: 1)'</span></div><div class="line">        )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'-f'</span>, <span class="string">'--file'</span>, dest=<span class="string">'logfile'</span>,</div><div class="line">        default=<span class="string">'spider.log'</span>,</div><div class="line">        help=<span class="string">'specify the path of logfile (default: spider.log)'</span></div><div class="line">        )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'-l'</span>, <span class="string">'--level'</span>, dest=<span class="string">'loglevel'</span>, choices=range(<span class="number">1</span>, <span class="number">6</span>),</div><div class="line">        default=<span class="number">1</span>, type=int,</div><div class="line">        help=<span class="string">'specify the verbose level of the log (default: 1)'</span></div><div class="line">        )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'--dbfile'</span>, dest=<span class="string">'dbfile'</span>,</div><div class="line">        default=<span class="string">'spider.db'</span>,</div><div class="line">        help=<span class="string">'specify the path of sqlite dbfile (default: spider.db)'</span></div><div class="line">        )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'--thread'</span>, dest=<span class="string">'num_threads'</span>,</div><div class="line">        default=<span class="number">10</span>, type=int,</div><div class="line">        help=<span class="string">'specify the size of thread pool (default: 10)'</span></div><div class="line">        )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'--keyword'</span>, dest=<span class="string">'keyword'</span>,</div><div class="line">        help=<span class="string">'specify the keyword'</span></div><div class="line">        )</div><div class="line">    parser.add_argument(</div><div class="line">        <span class="string">'--selftest'</span>, action=<span class="string">'store_true'</span>,</div><div class="line">        help=<span class="string">'self-test'</span></div><div class="line">        )</div><div class="line"></div><div class="line">    args = parser.parse_args()</div><div class="line">    <span class="comment"># &gt; Namespace(</span></div><div class="line">    <span class="comment">#     dbfile='spider.db', depth=1, keyword=None,</span></div><div class="line">    <span class="comment">#     logfile='spider.log', loglevel=1, num_threads=10,</span></div><div class="line">    <span class="comment">#     selftest=False, url='www.baidu.com'</span></div><div class="line">    <span class="comment">#     )</span></div><div class="line">    <span class="keyword">return</span> args</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    parse()</div></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://docs.python.org/2/howto/argparse.html" target="_blank" rel="external">https://docs.python.org/2/howto/argparse.html</a></li>
<li><a href="https://docs.python.org/2/library/argparse.html#choices" target="_blank" rel="external">https://docs.python.org/2/library/argparse.html#choices</a></li>
<li><a href="http://python.usyiyi.cn/python_278/library/argparse.html" target="_blank" rel="external">http://python.usyiyi.cn/python_278/library/argparse.html</a></li>
<li><a href="http://blog.xiayf.cn/2013/03/30/argparse/" target="_blank" rel="external">http://blog.xiayf.cn/2013/03/30/argparse/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Air9" />
          <p class="site-author-name" itemprop="name">Air9</p>
          <p class="site-description motion-element" itemprop="description">なぜベストを尽くしたのか</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">42</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">94</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Air9</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"answerrrrrrrrr"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  


</body>
</html>
