<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Answerrrrrrrrr" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="なぜベストを尽くしたのか">
<meta property="og:type" content="website">
<meta property="og:title" content="Answerrrrrrrrr">
<meta property="og:url" content="http://answerrrrrrrrr.io/page/3/index.html">
<meta property="og:site_name" content="Answerrrrrrrrr">
<meta property="og:description" content="なぜベストを尽くしたのか">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Answerrrrrrrrr">
<meta name="twitter:description" content="なぜベストを尽くしたのか">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Answerrrrrrrrr </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Answerrrrrrrrr</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/06/Spider-05-Spider/" itemprop="url">
                  Spider-05-Spider
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-06T09:00:36+08:00" content="2016-04-06">
              2016-04-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/06/Spider-05-Spider/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/06/Spider-05-Spider/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第五天：Spider"><a href="#知道创宇爬虫设计第五天：Spider" class="headerlink" title="知道创宇爬虫设计第五天：Spider"></a>知道创宇爬虫设计第五天：Spider</h1><p> 准备工作完成的差不多了，今天尝试下把之前的模块都整合起来做一个初期版本</p>
<p> 首先 <a href="http://stackoverflow.com/questions/4327392/what-is-the-difference-between-web-crawling-and-web-scraping" target="_blank" rel="external">What is the difference between web-crawling and web-scraping?</a><br>感觉其实这个答案比最佳答案更简洁明了  </p>
<blockquote>
<p>Web Crawling is what Google does - it goes around a website looking at links and building a database of the layout of that site and sites it links to</p>
<p>Web Scraping would be the progamatic analysis of a web page to load some data off of it, EG loading up BBC weather and ripping (scraping) the weather forcast off of it and placing it elsewhere or using it in another program.</p>
</blockquote>
<p>我的理解就是<code>web-crawling</code>在于广度，<code>web-scraping</code>在于精度</p>
<h1 id="BeautifulSoup"><a href="#BeautifulSoup" class="headerlink" title="BeautifulSoup"></a>BeautifulSoup</h1><p>为了<code>crawl</code>，需要从页面提取出用于进一步爬取的 URL ，BeautifulSoup 正好能方便快捷地完成这个任务，上手也很简单，基本上看看<a href="http://beautifulsoup.readthedocs.org/zh_CN/latest/" target="_blank" rel="external">官方文档</a>就万事大吉了</p>
<h1 id="FileHandler"><a href="#FileHandler" class="headerlink" title="FileHandler"></a>FileHandler</h1><p>在整合 logger 的时候发现一个问题，使用<code>logging.config.fileConfig(&#39;logging.conf&#39;)</code>的话，需要提前在配置文件里写定日志保存路径，为了配合参数设定其他路径，似乎（看了一下 <a href="http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler" target="_blank" rel="external">FileHandler</a> 的用法）只能额外添加一个了</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    # <span class="keyword">If</span> logfile <span class="keyword">is</span> <span class="keyword">not</span> <span class="string">'spider.log'</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        <span class="string">'%(asctime)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    logger.addHandler(file_handler)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>目前爬虫已经基本能用，但偶尔还是会出现<code>502</code>，然后该往数据库里放些什么东西还有待考虑，另外也没有加上自测功能</p>
<figure class="highlight python"><figcaption><span>myspider.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> Queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logging.config.fileConfig(<span class="string">'logging.conf'</span>)</span><br><span class="line">logger = logging.getLogger(<span class="string">'spider'</span>)</span><br><span class="line"></span><br><span class="line">levels = &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="string">'CRITICAL'</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">'ERROR'</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">'WARNING'</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="string">'INFO'</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlite</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, dbfile)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.warning(<span class="string">"Open database %s"</span> % dbfile)</span><br><span class="line">            self.conn = sqlite3.connect(dbfile)</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># print "Fail to connect %s: %s" % (dbfile, e) # e.args[0]</span></span><br><span class="line">            logger.error(<span class="string">"Fail to connect %s: %s"</span> % (dbfile, e))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, table)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.warning(<span class="string">"Create table %s if not exists"</span> % table)</span><br><span class="line">            self.cursor.execute(</span><br><span class="line">                <span class="string">"CREATE TABLE IF NOT EXISTS %s (id INTEGER PRIMARY KEY \</span><br><span class="line">                AUTOINCREMENT, url VARCHAR(100), data VARCHAR(40))"</span> % table)</span><br><span class="line">            self.conn.commit()</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">"Fail to create %s: %s"</span> % (table, e))</span><br><span class="line">            self.conn.rollback()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, table, url, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">"Insert (%s, %s) into table %s"</span> % (url, data, table))</span><br><span class="line">            self.cursor.execute(</span><br><span class="line">                <span class="string">"INSERT INTO %s (url, data) VALUES ('%s', '%s')"</span> %</span><br><span class="line">                (table, url, data))</span><br><span class="line">            self.conn.commit()</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">"Fail to insert (%s, %s) into %s: %s"</span> %</span><br><span class="line">                (url, data, table, e))</span><br><span class="line">            self.conn.rollback()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        logger.info(<span class="string">"Close database"</span>)</span><br><span class="line">        self.cursor.close()</span><br><span class="line">        self.conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThreadPool</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, num_threads=<span class="number">10</span>)</span>:</span></span><br><span class="line">        self.tasks = Queue(num_threads)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, num_threads+<span class="number">1</span>):</span><br><span class="line">            <span class="comment"># Initialize the pool with the number of num_threads</span></span><br><span class="line">            logger.info(<span class="string">'Initialize thread %d'</span> % i)</span><br><span class="line">            MyThread(self.tasks)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_task</span><span class="params">(self, func, *args, **kwargs)</span>:</span></span><br><span class="line">        self.tasks.put((func, args, kwargs))</span><br><span class="line">        logger.debug(<span class="string">'Add task'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_completion</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Blocks until all items in the queue have been gotten and processed.</span></span><br><span class="line">        self.tasks.join()</span><br><span class="line">        logger.info(<span class="string">'All tasks are done'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tasks)</span>:</span></span><br><span class="line">        Thread.__init__(self)</span><br><span class="line">        self.tasks = tasks</span><br><span class="line">        <span class="comment"># This must be set before start() is called. The entire Python program</span></span><br><span class="line">        <span class="comment"># exits when no alive non-daemon threads are left.</span></span><br><span class="line">        self.daemon = <span class="keyword">True</span></span><br><span class="line">        self.start()</span><br><span class="line">        logger.debug(<span class="string">'Thread started...'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="comment"># Block until an item is available.</span></span><br><span class="line">            func, args, kwargs = self.tasks.get()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                logger.warning(<span class="string">'Thread is working...'</span>)</span><br><span class="line">                func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(e)</span><br><span class="line">            <span class="comment"># Tells the queue that the processing on the task is complete.</span></span><br><span class="line">            self.tasks.task_done()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySpider</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        <span class="string">''' Initialize the spider</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="comment"># Initialize args</span></span><br><span class="line">        self.url = args.url</span><br><span class="line">        self.depth = args.depth</span><br><span class="line">        self.logfile = args.logfile</span><br><span class="line">        self.dbfile = args.dbfile</span><br><span class="line">        self.num_threads = args.num_threads</span><br><span class="line">        self.key = args.key.lower()</span><br><span class="line">        self.selftest = args.selftest</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Store visited url</span></span><br><span class="line">        self.visited_urls = set()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Initialize threadpool</span></span><br><span class="line">        self.threadpool = MyThreadPool(self.num_threads)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">''' Run the spider</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.url.startswith(<span class="string">'http://'</span>):</span><br><span class="line">            self.url = <span class="string">'http://'</span> + self.url</span><br><span class="line">        logger.critical(<span class="string">'Start crawl on %s'</span> % self.url)</span><br><span class="line">        self.threadpool.add_task(self.scrape, self.url, self.depth)</span><br><span class="line">        self.threadpool.wait_completion()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">scrape</span><span class="params">(self, url, depth)</span>:</span></span><br><span class="line">        <span class="string">''' Scrape the content of page</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="comment"># Open database with dbfile</span></span><br><span class="line">        db = MySqlite(self.dbfile)</span><br><span class="line">        <span class="comment"># Create table with keyword</span></span><br><span class="line">        table = <span class="string">'none'</span> <span class="keyword">if</span> <span class="keyword">not</span> self.key <span class="keyword">else</span> self.key</span><br><span class="line">        db.create(table)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Avoid being recognized as robot</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) \</span><br><span class="line">            AppleWebKit/537.36 (KHTML, like Gecko) \</span><br><span class="line">            Chrome/49.0.2623.110 Safari/537.36'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Avoid repeat</span></span><br><span class="line">        <span class="keyword">if</span> url <span class="keyword">in</span> self.visited_urls:</span><br><span class="line">            logger.debug(<span class="string">'%s had been crawled'</span> % url)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.visited_urls.add(url)</span><br><span class="line">            logger.info(<span class="string">'Crawling on %s'</span> % url)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Request with headers</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.warning(<span class="string">'Open %s'</span> % url)</span><br><span class="line">            request = urllib2.Request(url, headers=headers)</span><br><span class="line">            result = urllib2.urlopen(request).read()</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(e)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Extract the title by BeautifulSoup</span></span><br><span class="line">        soup = BeautifulSoup(result, <span class="string">"lxml"</span>)</span><br><span class="line">        title = soup.title.string</span><br><span class="line">        logger.debug(<span class="string">'title = %s'</span> % title)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Store url and title of the page with keyword into database</span></span><br><span class="line">        <span class="keyword">if</span> self.key <span class="keyword">in</span> result.lower():</span><br><span class="line">            table = <span class="string">'none'</span> <span class="keyword">if</span> <span class="keyword">not</span> self.key <span class="keyword">else</span> self.key</span><br><span class="line">            db.insert(table, url, title)</span><br><span class="line">            logger.critical(</span><br><span class="line">                <span class="string">'KEYWORD:\'%s\' - URL:\'%s\' - TITLE:\'%s\' (DEPTH:%d)'</span> %</span><br><span class="line">                (self.key, url, title, depth))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Close database after modification</span></span><br><span class="line">        db.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Go deeper into urls in result</span></span><br><span class="line">        self.crawl(soup, depth<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(self, soup, depth)</span>:</span></span><br><span class="line">        <span class="string">''' Crawl to new pages</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="keyword">if</span> depth &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> soup.find_all(<span class="string">'a'</span>):</span><br><span class="line">                url = link.get(<span class="string">'href'</span>)</span><br><span class="line">                <span class="comment"># scrape new url</span></span><br><span class="line">                self.threadpool.add_task(self.scrape, url, depth)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def stop(self):</span></span><br><span class="line">    <span class="comment">#     ''' Stop the spider</span></span><br><span class="line">    <span class="comment">#     '''</span></span><br><span class="line">    <span class="comment">#     logger.critical('OVER')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">args_parser</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">''' Parse the args</span><br><span class="line">    '''</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line"></span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-u'</span>, <span class="string">'--url'</span>, dest=<span class="string">'url'</span>, required=<span class="keyword">True</span>,</span><br><span class="line">        help=<span class="string">'specify the URL to start crawl'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-d'</span>, <span class="string">'--depth'</span>, dest=<span class="string">'depth'</span>, default=<span class="number">1</span>, type=int,</span><br><span class="line">        help=<span class="string">'specify the depth of the spider (default: 1)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-f'</span>, <span class="string">'--file'</span>, dest=<span class="string">'logfile'</span>, default=<span class="string">'spider.log'</span>,</span><br><span class="line">        help=<span class="string">'specify the path of logfile (default: spider.log)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-l'</span>, <span class="string">'--level'</span>, dest=<span class="string">'loglevel'</span>, default=<span class="number">5</span>, type=int,</span><br><span class="line">        choices=range(<span class="number">1</span>, <span class="number">6</span>),</span><br><span class="line">        help=<span class="string">'specify the verbose level of the log (default: 5)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--dbfile'</span>, dest=<span class="string">'dbfile'</span>, default=<span class="string">'spider.db'</span>,</span><br><span class="line">        help=<span class="string">'specify the path of sqlite dbfile (default: spider.db)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--thread'</span>, dest=<span class="string">'num_threads'</span>, default=<span class="number">10</span>, type=int,</span><br><span class="line">        help=<span class="string">'specify the size of thread pool (default: 10)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--key'</span>, dest=<span class="string">'key'</span>, default=<span class="string">''</span>,</span><br><span class="line">        help=<span class="string">'specify the keyword (default: '</span><span class="string">')'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--selftest'</span>, action=<span class="string">'store_true'</span>,</span><br><span class="line">        help=<span class="string">'self-test'</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_logger</span><span class="params">(loglevel, logfile)</span>:</span></span><br><span class="line">    <span class="string">''' Set the logger with loglevel and logfile</span><br><span class="line">    '''</span></span><br><span class="line">    logger.setLevel(levels[loglevel])</span><br><span class="line">    file_handler = logging.FileHandler(logfile)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If logfile is not 'spider.log'</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        <span class="string">'%(asctime)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    args = args_parser()</span><br><span class="line">    set_logger(args.loglevel, args.logfile)</span><br><span class="line">    logger.debug(args)</span><br><span class="line"></span><br><span class="line">    spider = MySpider(args)</span><br><span class="line">    spider.run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://beautifulsoup.readthedocs.org/zh_CN/latest/" target="_blank" rel="external">http://beautifulsoup.readthedocs.org/zh_CN/latest/</a></li>
<li><a href="http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler" target="_blank" rel="external">http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler</a></li>
<li><a href="http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/" target="_blank" rel="external">http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/Sublime-Packages/" itemprop="url">
                  Sublime Preferences
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-05T16:24:00+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Sublime/" itemprop="url" rel="index">
                    <span itemprop="name">Sublime</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/Sublime-Packages/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/Sublime-Packages/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="切换标签页"><a href="#切换标签页" class="headerlink" title="切换标签页"></a>切换标签页</h1><p>首先，Sublime 的所谓「标签页智能切换」很蛋疼，改成通用快捷键设定</p>
<figure class="highlight js"><figcaption><span>Default (OSX).sublime-keymap</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"keys"</span>: [<span class="string">"ctrl+tab"</span>],</span><br><span class="line">    <span class="string">"command"</span>: <span class="string">"next_view"</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"keys"</span>: [<span class="string">"ctrl+shift+tab"</span>],</span><br><span class="line">    <span class="string">"command"</span>: <span class="string">"prev_view"</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h1 id="Vintage"><a href="#Vintage" class="headerlink" title="Vintage"></a><a href="https://github.com/sublimehq/Vintage" target="_blank" rel="external">Vintage</a></h1><p>这个是Sublime自带的vi模式<br>先注释掉<code>Preferences.sublime-settings</code>里的<code>Vintage</code></p>
<figure class="highlight js"><figcaption><span>Preferences.sublime-settings</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="string">"ignored_packages"</span>:[</span><br><span class="line">        <span class="comment">// "Vintage"</span></span><br><span class="line">    ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>再按照习惯把<code>esc</code>改成<code>j</code> <code>j</code></p>
<figure class="highlight js"><figcaption><span>Default (OSX).sublime-keymap</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">// Vintage</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"keys"</span>: [<span class="string">"j"</span>, <span class="string">"j"</span>],</span><br><span class="line">        <span class="string">"command"</span>: <span class="string">"exit_insert_mode"</span>,</span><br><span class="line">        <span class="string">"context"</span>:[</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"key"</span>: <span class="string">"setting.command_mode"</span>,</span><br><span class="line">                <span class="string">"operand"</span>: <span class="literal">false</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"key"</span>: <span class="string">"setting.is_widget"</span>,</span><br><span class="line">                <span class="string">"operand"</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>另外还有一个<a href="https://github.com/SublimeText/VintageEx" target="_blank" rel="external">VintageEx</a>，不过我倒是没有太大需求</p>
<h1 id="SublimeREPL"><a href="#SublimeREPL" class="headerlink" title="SublimeREPL"></a><a href="https://github.com/wuub/SublimeREPL" target="_blank" rel="external">SublimeREPL</a></h1><p>无意中发现一个类似 Vim 下 quickrun 的插件<code>SublimeREPL</code></p>
<p>在<code>Perferences</code>-<code>Key Bindings - User</code>中加入</p>
<figure class="highlight js"><figcaption><span>Default (OSX).sublime-keymap</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="comment">// SublimeREPL - Python</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"keys"</span>: [<span class="string">"f2"</span>],</span><br><span class="line">        <span class="string">"caption"</span>: <span class="string">"SublimeREPL: Python - RUN current file"</span>,</span><br><span class="line">        <span class="string">"command"</span>: <span class="string">"run_existing_window_command"</span>,</span><br><span class="line">        <span class="string">"args"</span>: &#123;</span><br><span class="line">            <span class="string">"id"</span>: <span class="string">"repl_python_run"</span>,</span><br><span class="line">            <span class="string">"file"</span>: <span class="string">"config/Python/Main.sublime-menu"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这样一来，保存之后按<code>F2</code>即可快速运行 Python 脚本，不用来回切换终端了<br>C’est bon!</p>
<h1 id="ExpandRegion"><a href="#ExpandRegion" class="headerlink" title="ExpandRegion"></a><a href="https://github.com/aronwoost/sublime-expand-region" target="_blank" rel="external">ExpandRegion</a></h1><p>在<a href="https://www.zhihu.com/question/24896283" target="_blank" rel="external">知乎</a>看到推荐感觉挺不错，用于快速扩展选区，也是在<code>Perferences</code>-<code>Key Bindings - User</code>中加入</p>
<figure class="highlight js"><figcaption><span>Default (OSX).sublime-keymap</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"keys"</span>: [<span class="string">"super+e"</span>],</span><br><span class="line">        <span class="string">"command"</span>: <span class="string">"expand_region"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"keys"</span>: [<span class="string">"super+u"</span>],</span><br><span class="line">        <span class="string">"command"</span>: <span class="string">"expand_region"</span>,</span><br><span class="line">        <span class="string">"args"</span>: &#123;</span><br><span class="line">            <span class="string">"undo"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"context"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"key"</span>: <span class="string">"expand_region_soft_undo"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h1 id="Anaconda"><a href="#Anaconda" class="headerlink" title="Anaconda"></a><a href="https://github.com/DamnWidget/anaconda" target="_blank" rel="external">Anaconda</a></h1><p>这个插件确实强大，不过有点小问题</p>
<h2 id="import-时不能自动补全"><a href="#import-时不能自动补全" class="headerlink" title="import 时不能自动补全"></a>import 时不能自动补全</h2><p>在<a href="https://github.com/DamnWidget/anaconda/issues/89" target="_blank" rel="external">Stackoverflow</a>找到解决方案<br>新建<code>/Users/air9/Library/Application\ Support/Sublime\ Text\ 3/Packages/Python/Completion\ Rules.tmPreferences</code>并加入如下内容</p>
<figure class="highlight xml"><figcaption><span>Completion Rules.tmPreferences</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">"1.0"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>scope<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>source.python<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>settings<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">key</span>&gt;</span>cancelCompletion<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>^(.*\b(and|or)$)|(\s*(pass|return|and|or|(class|def)\s*[a-zA-Z_0-9]+)$)<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>保存后重启 Sublime 即可</p>
<p><strong>不过第一次弄的时候，不知道怎么回事出现了配置文件被初始化的 bug，所有插件和改键都失效了。。。还好我碰巧刚刚做了备份，所以下次也要记得先备份一下</strong></p>
<h2 id="过于频繁的补全弹窗"><a href="#过于频繁的补全弹窗" class="headerlink" title="过于频繁的补全弹窗"></a>过于频繁的补全弹窗</h2><p>随便按一个空格就以<code>a</code>开头弹窗提示我补全，有时甚至回车补全完成之后弹窗仍然消失不掉，一怒之下禁用掉了</p>
<figure class="highlight js"><figcaption><span>Anaconda.sublime-settings</span></figcaption><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    <span class="comment">/*</span><br><span class="line">        Disable anaconda completion</span><br><span class="line"></span><br><span class="line">        WARNING: set this as true will totally disable anaconda completion</span><br><span class="line">    */</span></span><br><span class="line">    <span class="comment">// "disable_anaconda_completion": false,</span></span><br><span class="line">    <span class="string">"disable_anaconda_completion"</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span><br><span class="line">...</span></span><br></pre></td></tr></table></figure>
<p>Sublime 自带的轻量级补全其实已经满足我的日常需求了，装 Anaconda 主要还是为了 Tooltip 和 PEP8 提示</p>
<h1 id="MarkdownEditing"><a href="#MarkdownEditing" class="headerlink" title="MarkdownEditing"></a><a href="https://github.com/SublimeText-Markdown/MarkdownEditing" target="_blank" rel="external">MarkdownEditing</a></h1><p>这个其实用处不大，平常在 Mac 上写 Markdown 都用的 MacDown<br>不过默认会渲染 txt 还是挺蛋疼的，注释掉<br>顺便改个主题</p>
<figure class="highlight js"><figcaption><span>Markdown.sublime-settings</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"extensions"</span>:</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"md"</span>,</span><br><span class="line">        <span class="string">"mdown"</span>,</span><br><span class="line">        <span class="comment">// "txt"</span></span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="string">"color_scheme"</span>: <span class="string">"Packages/MarkdownEditing/MarkdownEditor-Dark.tmTheme"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/Spider-04-sqlite/" itemprop="url">
                  Spider-04-sqlite3
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-05T09:39:06+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/Spider-04-sqlite/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/Spider-04-sqlite/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第四天：sqlite3"><a href="#知道创宇爬虫设计第四天：sqlite3" class="headerlink" title="知道创宇爬虫设计第四天：sqlite3"></a>知道创宇爬虫设计第四天：sqlite3</h1><p>这部分比较简单，需要注意的几点</p>
<ul>
<li>connect, cursor</li>
<li>execute</li>
<li>commit, rollback</li>
<li>close</li>
</ul>
<p>既然之前已经学会了使用logging，就可以尝试下配合着使用</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><figcaption><span>MySqlite.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line">logging.config.fileConfig(<span class="string">'logging.conf'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">levels = &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="string">'CRITICAL'</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">'ERROR'</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">'WARNING'</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="string">'INFO'</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">&#125;</span><br><span class="line">loglevel = <span class="number">4</span></span><br><span class="line">logger = logging.getLogger(<span class="string">'spider'</span>)</span><br><span class="line">logger.setLevel(levels[loglevel])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlite</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, dbfile)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.conn = sqlite3.connect(dbfile)</span><br><span class="line">            logger.info(<span class="string">"Open database %s"</span> % dbfile)</span><br><span class="line">            logger.debug(<span class="string">"Open database %s"</span> % dbfile)</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># print "Fail to connect %s: %s" % (dbfile, e) # e.args[0]</span></span><br><span class="line">            logger.error(<span class="string">"Fail to connect %s: %s"</span> % (dbfile, e))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, table)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.info(<span class="string">"Create table %s"</span> % table)</span><br><span class="line">            self.cursor.execute(</span><br><span class="line">                <span class="string">"CREATE TABLE IF NOT EXISTS %s(Id INTEGER PRIMARY KEY \</span><br><span class="line">                AUTOINCREMENT, Data VARCHAR(40))"</span> % table</span><br><span class="line">                )</span><br><span class="line">            self.conn.commit()</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">"Fail to create %s: %s"</span> % (table, e))</span><br><span class="line">            self.conn.rollback()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, table, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.info(<span class="string">"Insert %s into table %s"</span> % (data, table))</span><br><span class="line">            self.cursor.execute(</span><br><span class="line">                <span class="string">"INSERT INTO %s(Data) VALUES('%s')"</span> % (table, data))</span><br><span class="line">            self.conn.commit()</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">"Fail to insert %s into %s: %s"</span> % (data, table, e))</span><br><span class="line">            self.conn.rollback()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        logger.info(<span class="string">"Close database"</span>)</span><br><span class="line">        self.cursor.close()</span><br><span class="line">        self.conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    ms = MySqlite(<span class="string">'spider.db'</span>)</span><br><span class="line">    ms.create(<span class="string">'t1'</span>)</span><br><span class="line">    ms.insert(<span class="string">'t1'</span>, <span class="string">'test'</span>)</span><br><span class="line">    ms.close()</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>logging.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">[loggers]</span><br><span class="line">keys = root, spider</span><br><span class="line"></span><br><span class="line">[handlers]</span><br><span class="line">keys = consoleHandler, fileHandler</span><br><span class="line"></span><br><span class="line">[formatters]</span><br><span class="line">keys = simpleFormatter</span><br><span class="line"></span><br><span class="line">[logger_root]</span><br><span class="line">level = DEBUG</span><br><span class="line">handlers = consoleHandler</span><br><span class="line"></span><br><span class="line">[logger_spider]</span><br><span class="line">level = DEBUG</span><br><span class="line">handlers = consoleHandler, fileHandler</span><br><span class="line">qualname = spider</span><br><span class="line">propagate = 0</span><br><span class="line"></span><br><span class="line">[handler_consoleHandler]</span><br><span class="line">class = StreamHandler</span><br><span class="line">level = DEBUG</span><br><span class="line">formatter = simpleFormatter</span><br><span class="line">args = (sys.stdout,)</span><br><span class="line"></span><br><span class="line">[handler_fileHandler]</span><br><span class="line">class = FileHandler</span><br><span class="line">level = DEBUG</span><br><span class="line">formatter = simpleFormatter</span><br><span class="line">args = (&apos;spider.log&apos;, &apos;w&apos;)</span><br><span class="line"></span><br><span class="line">[formatter_simpleFormatter]</span><br><span class="line">format = %(asctime)s - %(name)s - %(levelname)s - %(message)s</span><br><span class="line">datefmt =</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://docs.python.org/2/library/sqlite3.html" target="_blank" rel="external">https://docs.python.org/2/library/sqlite3.html</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_72603eac01013pbc.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_72603eac01013pbc.html</a></li>
<li><a href="http://blog.csdn.net/jeepxiaozi/article/details/8808435" target="_blank" rel="external">http://blog.csdn.net/jeepxiaozi/article/details/8808435</a></li>
<li><a href="http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/" target="_blank" rel="external">http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/</a></li>
<li><a href="http://devdocs.io/python~2.7/library/logging.config" target="_blank" rel="external">http://devdocs.io/python~2.7/library/logging.config</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/04/Spider-03-argparse/" itemprop="url">
                  Spider-03-argparse
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-04T15:39:12+08:00" content="2016-04-04">
              2016-04-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/04/Spider-03-argparse/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/04/Spider-03-argparse/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第三天：argparse"><a href="#知道创宇爬虫设计第三天：argparse" class="headerlink" title="知道创宇爬虫设计第三天：argparse"></a>知道创宇爬虫设计第三天：argparse</h1><p>题目原本是2012年的，要求的optparse模块已经过时，因此按照argparse来学习</p>
<p>提取要点如下：</p>
<ul>
<li><code>class argparse.ArgumentParser(prog=None, usage=None, description=None, epilog=None, parents=[], formatter_class=argparse.HelpFormatter, prefix_chars=&#39;-&#39;, fromfile_prefix_chars=None, argument_default=None, conflict_handler=&#39;error&#39;, add_help=True)</code></li>
<li><code>ArgumentParser.add_argument(name or flags...[, action][, nargs][, const][, default][, type][, choices][, required][, help][, metavar][, dest])</code></li>
<li>ArgumentParser通过parse_args()方法解析参数。它将检查命令行，把每个参数转换成恰当的类型并采取恰当的动作。在大部分情况下，这意味着将从命令行中解析出来的属性建立一个简单的 Namespace对象</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">()</span>:</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line"></span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-u'</span>, <span class="string">'--url'</span>, dest=<span class="string">'url'</span>, required=<span class="keyword">True</span>,</span><br><span class="line">        help=<span class="string">'specify the URL to start crawl'</span></span><br><span class="line">        )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-d'</span>, <span class="string">'--depth'</span>, dest=<span class="string">'depth'</span>,</span><br><span class="line">        default=<span class="number">1</span>, type=int,</span><br><span class="line">        help=<span class="string">'specify the depth of the spider (default: 1)'</span></span><br><span class="line">        )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-f'</span>, <span class="string">'--file'</span>, dest=<span class="string">'logfile'</span>,</span><br><span class="line">        default=<span class="string">'spider.log'</span>,</span><br><span class="line">        help=<span class="string">'specify the path of logfile (default: spider.log)'</span></span><br><span class="line">        )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-l'</span>, <span class="string">'--level'</span>, dest=<span class="string">'loglevel'</span>, choices=range(<span class="number">1</span>, <span class="number">6</span>),</span><br><span class="line">        default=<span class="number">1</span>, type=int,</span><br><span class="line">        help=<span class="string">'specify the verbose level of the log (default: 1)'</span></span><br><span class="line">        )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--dbfile'</span>, dest=<span class="string">'dbfile'</span>,</span><br><span class="line">        default=<span class="string">'spider.db'</span>,</span><br><span class="line">        help=<span class="string">'specify the path of sqlite dbfile (default: spider.db)'</span></span><br><span class="line">        )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--thread'</span>, dest=<span class="string">'num_threads'</span>,</span><br><span class="line">        default=<span class="number">10</span>, type=int,</span><br><span class="line">        help=<span class="string">'specify the size of thread pool (default: 10)'</span></span><br><span class="line">        )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--keyword'</span>, dest=<span class="string">'keyword'</span>,</span><br><span class="line">        help=<span class="string">'specify the keyword'</span></span><br><span class="line">        )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--selftest'</span>, action=<span class="string">'store_true'</span>,</span><br><span class="line">        help=<span class="string">'self-test'</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="comment"># &gt; Namespace(</span></span><br><span class="line">    <span class="comment">#     dbfile='spider.db', depth=1, keyword=None,</span></span><br><span class="line">    <span class="comment">#     logfile='spider.log', loglevel=1, num_threads=10,</span></span><br><span class="line">    <span class="comment">#     selftest=False, url='www.baidu.com'</span></span><br><span class="line">    <span class="comment">#     )</span></span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    parse()</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://docs.python.org/2/howto/argparse.html" target="_blank" rel="external">https://docs.python.org/2/howto/argparse.html</a></li>
<li><a href="https://docs.python.org/2/library/argparse.html#choices" target="_blank" rel="external">https://docs.python.org/2/library/argparse.html#choices</a></li>
<li><a href="http://python.usyiyi.cn/python_278/library/argparse.html" target="_blank" rel="external">http://python.usyiyi.cn/python_278/library/argparse.html</a></li>
<li><a href="http://blog.xiayf.cn/2013/03/30/argparse/" target="_blank" rel="external">http://blog.xiayf.cn/2013/03/30/argparse/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/03/Spider-02-logging/" itemprop="url">
                  Spider-02-logging
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-03T21:42:37+08:00" content="2016-04-03">
              2016-04-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/03/Spider-02-logging/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/03/Spider-02-logging/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第二天：logging"><a href="#知道创宇爬虫设计第二天：logging" class="headerlink" title="知道创宇爬虫设计第二天：logging"></a>知道创宇爬虫设计第二天：logging</h1><p><a href="http://blog.chinaunix.net/uid-26000296-id-4372063.html" target="_blank" rel="external">此文章</a>的测试用例详细实用，对logging模块的解析也很不错，现把自己理解的要点摘录如下</p>
<ul>
<li>只要logging.getLogger(name)中名称参数name相同则返回的Logger实例就是同一个，且仅有一个，也即name与Logger实例一一对应</li>
<li>子孙既会将消息分发给他的handler进行处理，也会传递给所有的祖先Logger处理</li>
<li>若为Handler加Filter则所有使用了该Handler的Logger都会受到影响。而为Logger添加Filter只会影响到自身</li>
<li>典型的多模块场景下使用logging的方式，是在main模块中配置logging，这个配置会作用于其所有子模块</li>
<li>使用配置文件<code>logging.config.fileConfig(&quot;logging.conf&quot;)</code>(<a href="http://my.oschina.net/leejun2005/blog/126713" target="_blank" rel="external">来源</a>)</li>
</ul>
<figure class="highlight"><figcaption><span>logging.conf</span></figcaption><table><tr><td class="code"><pre><span class="line"># 定义logger模块，root是父类，必需存在的，其它的是自定义。</span><br><span class="line"># logging.getLogger(NAME)便相当于向logging模块注册了一种日志打印</span><br><span class="line"># name 中用 . 表示 log 的继承关系</span><br><span class="line">[loggers]</span><br><span class="line">keys=root,infoLogger,errorLogger</span><br><span class="line"> </span><br><span class="line"># 定义handler</span><br><span class="line">[handlers]</span><br><span class="line">keys=infoHandler,errorHandler</span><br><span class="line"> </span><br><span class="line"># 定义格式化输出</span><br><span class="line">[formatters]</span><br><span class="line">keys=infoFmt,errorFmt</span><br><span class="line"> </span><br><span class="line">#--------------------------------------------------</span><br><span class="line"># 实现上面定义的logger模块，必需是[logger_xxxx]这样的形式</span><br><span class="line">#--------------------------------------------------</span><br><span class="line"># [logger_xxxx] logger_模块名称</span><br><span class="line"># level     级别，级别有DEBUG、INFO、WARNING、ERROR、CRITICAL</span><br><span class="line"># handlers  处理类，可以有多个，用逗号分开</span><br><span class="line"># qualname  logger名称，应用程序通过 logging.getLogger获取。对于不能获取的名称，则记录到root模块。</span><br><span class="line"># propagate 是否继承父类的log信息，0:否 1:是</span><br><span class="line">[logger_root]</span><br><span class="line">level=INFO</span><br><span class="line">handlers=errorHandler</span><br><span class="line"> </span><br><span class="line">[logger_errorLogger]</span><br><span class="line">level=ERROR</span><br><span class="line">handlers=errorHandler</span><br><span class="line">propagate=0</span><br><span class="line">qualname=errorLogger</span><br><span class="line"> </span><br><span class="line">[logger_infoLogger]</span><br><span class="line">level=INFO</span><br><span class="line">handlers=infoHandler</span><br><span class="line">propagate=0</span><br><span class="line">qualname=infoLogger</span><br><span class="line"> </span><br><span class="line">#--------------------------------------------------</span><br><span class="line"># handler</span><br><span class="line">#--------------------------------------------------</span><br><span class="line"># [handler_xxxx]</span><br><span class="line"># class handler类名</span><br><span class="line"># level 日志级别</span><br><span class="line"># formatter，上面定义的formatter</span><br><span class="line"># args handler初始化函数参数</span><br><span class="line"> </span><br><span class="line">[handler_infoHandler]</span><br><span class="line">class=StreamHandler</span><br><span class="line">level=INFO</span><br><span class="line">formatter=infoFmt</span><br><span class="line">args=(sys.stdout,)</span><br><span class="line"> </span><br><span class="line">[handler_errorHandler]</span><br><span class="line">class=logging.handlers.TimedRotatingFileHandler</span><br><span class="line">level=ERROR</span><br><span class="line">formatter=errorFmt</span><br><span class="line"># When computing the next rollover time for the first time (when the handler is created),</span><br><span class="line"># the last modification time of an existing log file, or else the current time,</span><br><span class="line"># is used to compute when the next rotation will occur.</span><br><span class="line"># 这个功能太鸡肋了，是从handler被创建的时间算起，不能按自然时间 rotation 切分，除非程序一直运行，否则这个功能会有问题</span><br><span class="line"># 临时解决方案参考下面的链接：Python 多进程日志记录</span><br><span class="line"># http://blogread.cn/it/article/4175?f=wb2</span><br><span class="line">args=('C:\\Users\\june\\Desktop\\error.log', 'M', 1, 5)</span><br><span class="line"> </span><br><span class="line">#--------------------------------------------------</span><br><span class="line"># 日志格式</span><br><span class="line">#--------------------------------------------------</span><br><span class="line"># %(asctime)s       年-月-日 时-分-秒,毫秒 2013-04-26 20:10:43,745</span><br><span class="line"># %(filename)s      文件名，不含目录</span><br><span class="line"># %(pathname)s      目录名，完整路径</span><br><span class="line"># %(funcName)s      函数名</span><br><span class="line"># %(levelname)s     级别名</span><br><span class="line"># %(lineno)d        行号</span><br><span class="line"># %(module)s        模块名</span><br><span class="line"># %(message)s       消息体</span><br><span class="line"># %(name)s          日志模块名</span><br><span class="line"># %(process)d       进程id</span><br><span class="line"># %(processName)s   进程名</span><br><span class="line"># %(thread)d        线程id</span><br><span class="line"># %(threadName)s    线程名</span><br><span class="line"> </span><br><span class="line">[formatter_infoFmt]</span><br><span class="line">format=%(asctime)s %(levelname)s %(message)s</span><br><span class="line">datefmt=</span><br><span class="line">class=logging.Formatter</span><br><span class="line"> </span><br><span class="line">[formatter_errorFmt]</span><br><span class="line">format=%(asctime)s %(levelname)s %(message)s</span><br><span class="line">datefmt=</span><br><span class="line">class=logging.Formatter</span><br></pre></td></tr></table></figure>
<h1 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h1><figure class="highlight python"><figcaption><span>main.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'Air9'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"></span><br><span class="line">logging.config.fileConfig(<span class="string">'main.conf'</span>)</span><br><span class="line">root_logger = logging.getLogger(<span class="string">'root'</span>)</span><br><span class="line">root_logger.debug(<span class="string">'test root logger'</span>)</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">'main'</span>)</span><br><span class="line">logger.info(<span class="string">'test main logger'</span>)</span><br><span class="line">logger.info(<span class="string">'start import mod'</span>)</span><br><span class="line"><span class="keyword">import</span> mod</span><br><span class="line"></span><br><span class="line">logger.debug(<span class="string">'test mod.testmod()'</span>)</span><br><span class="line">mod.testmod()</span><br><span class="line"></span><br><span class="line">root_logger.info(<span class="string">'finish test'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight"><figcaption><span>main.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">[loggers]</span><br><span class="line">keys = root, main</span><br><span class="line"></span><br><span class="line">[handlers]</span><br><span class="line">keys = consoleHandler</span><br><span class="line"></span><br><span class="line">[formatters]</span><br><span class="line">keys = simpleFormatter</span><br><span class="line"></span><br><span class="line">[logger_root]</span><br><span class="line">level = DEBUG</span><br><span class="line">handlers = consoleHandler</span><br><span class="line"></span><br><span class="line">[logger_main]</span><br><span class="line">level = DEBUG</span><br><span class="line">handlers = consoleHandler</span><br><span class="line">qualname = main</span><br><span class="line">propagate = 0</span><br><span class="line"></span><br><span class="line">[handler_consoleHandler]</span><br><span class="line">class = StreamHandler</span><br><span class="line">level = DEBUG</span><br><span class="line">formatter = simpleFormatter</span><br><span class="line">args = (sys.stdout,)</span><br><span class="line"></span><br><span class="line">[formatter_simpleFormatter]</span><br><span class="line">format = %(asctime)s - %(name)s - [line:%(lineno)d] - %(levelname)s - %(message)s</span><br><span class="line">datefmt =</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><figcaption><span>mod.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'Air9'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> submod</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">'main.mod'</span>)</span><br><span class="line">logger.info(<span class="string">'logger main.mod'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">testmod</span><span class="params">()</span>:</span></span><br><span class="line">    logger.debug(<span class="string">'test mod.testmod()'</span>)</span><br><span class="line">    submod.testsubmod()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><figcaption><span>submod.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">'Air9'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">'main.mod.submod'</span>)</span><br><span class="line">logger.info(<span class="string">'submod.logger'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">testsubmod</span><span class="params">()</span>:</span></span><br><span class="line">    logger.debug(<span class="string">'test submod.testsubmod()'</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><figcaption><span>output</span></figcaption><table><tr><td class="code"><pre><span class="line">2016-04-04 14:46:24,148 - root - [line:13] - DEBUG - test root logger</span><br><span class="line">2016-04-04 14:46:24,148 - main - [line:16] - INFO - test main logger</span><br><span class="line">2016-04-04 14:46:24,148 - main - [line:17] - INFO - start import mod</span><br><span class="line">2016-04-04 14:46:24,148 - main.mod.submod - [line:11] - INFO - submod.logger</span><br><span class="line">2016-04-04 14:46:24,148 - main.mod - [line:12] - INFO - logger main.mod</span><br><span class="line">2016-04-04 14:46:24,149 - main - [line:20] - DEBUG - test mod.testmod()</span><br><span class="line">2016-04-04 14:46:24,149 - main.mod - [line:15] - DEBUG - test mod.testmod()</span><br><span class="line">2016-04-04 14:46:24,149 - main.mod.submod - [line:14] - DEBUG - test submod.looger</span><br><span class="line">2016-04-04 14:46:24,149 - root - [line:23] - INFO - finish test</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://my.oschina.net/leejun2005/blog/126713" target="_blank" rel="external">http://my.oschina.net/leejun2005/blog/126713</a></li>
<li><a href="http://blog.chinaunix.net/uid-26000296-id-4372063.html" target="_blank" rel="external">http://blog.chinaunix.net/uid-26000296-id-4372063.html</a></li>
<li><a href="http://www.tuicool.com/articles/bmMfUfE" target="_blank" rel="external">http://www.tuicool.com/articles/bmMfUfE</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/02/Spider-01-MyThreadPool/" itemprop="url">
                  Spider-01-MyThreadPool
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-02T16:08:14+08:00" content="2016-04-02">
              2016-04-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/02/Spider-01-MyThreadPool/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/02/Spider-01-MyThreadPool/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第一天：threadpool"><a href="#知道创宇爬虫设计第一天：threadpool" class="headerlink" title="知道创宇爬虫设计第一天：threadpool"></a>知道创宇爬虫设计第一天：threadpool</h1><p>题目要求自己实现线程池，研究了好几篇博客之后，大致提取出几个要点：</p>
<ul>
<li>使用默认的<code>Thread()</code>创建线程时，通常都是直接绑定一个具体的<code>func</code><br>但若使用线程池，初始化的线程数在有些时候可能会多于任务数<br>因此，在自定义<code>MyThread()</code>时，采用先绑定整个任务队列，然后逐条取出任务<code>func</code>执行的方式   </li>
<li>使用<code>MyThreadPool</code>提前创建所需数目的线程，再分配给具体任务<code>func</code></li>
<li>自定义<code>MyThread()</code>中需设置<code>self.daemon = True</code>，否则完成所有任务后仍不会推出</li>
<li><code>Queue()</code>提供了两个非常好用的方法<ul>
<li><code>task_done()</code>一条任务完成时通知整个队列，空闲下来的线程就可以被分配新任务</li>
<li><code>join()</code>在所有任务执行完成之前阻塞主线程</li>
</ul>
</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> Queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThreadPool</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, num_threads=<span class="number">20</span>)</span>:</span></span><br><span class="line">        self.tasks = Queue(num_threads)</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> xrange(num_threads):</span><br><span class="line">            <span class="comment"># Init the pool with the number of num_threads</span></span><br><span class="line">            MyThread(self.tasks)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_task</span><span class="params">(self, func, *args, **kwargs)</span>:</span></span><br><span class="line">        self.tasks.put((func, args, kwargs))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_completion</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Blocks until all items in the queue have been gotten and processed.</span></span><br><span class="line">        self.tasks.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tasks)</span>:</span></span><br><span class="line">        Thread.__init__(self)</span><br><span class="line">        self.tasks = tasks</span><br><span class="line">        <span class="comment"># This must be set before start() is called. The entire Python program</span></span><br><span class="line">        <span class="comment"># exits when no alive non-daemon threads are left.</span></span><br><span class="line">        self.daemon = <span class="keyword">True</span></span><br><span class="line">        self.start()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="comment"># Block until an item is available.</span></span><br><span class="line">            func, args, kwargs = self.tasks.get()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">print</span> e</span><br><span class="line">            <span class="comment"># Tells the queue that the processing on the task is complete.</span></span><br><span class="line">            self.tasks.task_done()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="string">''' test task '''</span></span><br><span class="line">    <span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">nap</span><span class="params">(sec)</span>:</span></span><br><span class="line">        sleep(sec)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Had a %ds nap...'</span> % sec</span><br><span class="line"></span><br><span class="line">    tp = MyThreadPool(<span class="number">5</span>)</span><br><span class="line">    nap_time = [i <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, <span class="number">11</span>)]</span><br><span class="line">    <span class="keyword">for</span> i, t <span class="keyword">in</span> enumerate(nap_time, <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'Worker No.%d needs a %ds nap.'</span> % (i, t)</span><br><span class="line">        tp.add_task(nap, t)</span><br><span class="line"></span><br><span class="line">    tp.wait_completion()</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="http://www.the5fire.com/python-thread-pool.html" target="_blank" rel="external">python线程池</a>   </li>
<li><a href="http://github.howie.wang/2016/01/07/python-threading/" target="_blank" rel="external">【Howie玩python】-多线程从0到1到澡堂子洗澡</a></li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/10/capstone/" itemprop="url">
                  ropgadget capstone
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-10T15:41:52+08:00" content="2016-03-10">
              2016-03-10
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/rop/" itemprop="url" rel="index">
                    <span itemprop="name">rop</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/10/capstone/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/10/capstone/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="import-error"><a href="#import-error" class="headerlink" title="import error"></a>import error</h1><p><a href="https://github.com/aquynh/capstone" target="_blank" rel="external">capstone</a>是一个著名的反汇编框架<br><a href="https://github.com/JonathanSalwan/ROPgadget" target="_blank" rel="external">ropgadget</a>会用到</p>
<p>但是每次<code>pip install ropgadget</code>之后都会报错<br><code>import error:ERROR: fail to load the dynamic library.</code></p>
<blockquote>
<p>2016.5.10 补充：ropgadget 里的依赖的 capstone 版本为2.1，而目前最新版本为3.0.4，pip更新 ropgadget 后会降级。。。需<code>pip install -U capstone</code></p>
</blockquote>
<p>原因在于所需的动态库文件libcapstone.dylib没有位于capstone主目录<br>所以找到libcapstone.dylib并拷贝一个就可以了</p>
<p>有两种方法</p>
<h2 id="sudo-find-name-‘libcapstone-’"><a href="#sudo-find-name-‘libcapstone-’" class="headerlink" title="sudo find / -name ‘libcapstone.*’"></a>sudo find / -name ‘libcapstone.*’</h2><p>原来作者把动态库写在了这么一个奇葩的地址<br><code>/usr/local/lib/python2.7/site-packages/usr/local/Cellar/python/2.7.11/Frameworks/Python.framework/Versions/2.7/lib/python2.7/site-packages/capstone/libcapstone.dylib</code><br>大概是写掉了一个<code>/</code>吧，参考 <a href="https://github.com/aquynh/capstone/pull/406" target="_blank" rel="external">https://github.com/aquynh/capstone/pull/406</a></p>
<h2 id="pip-uninstall-capstone"><a href="#pip-uninstall-capstone" class="headerlink" title="pip uninstall capstone"></a>pip uninstall capstone</h2><p>这个方法略显鸡贼，但更快一点<br>可以发现列出了所有与capstone相关的文件<br>其中最后一个就是要找的libcapstone.dylib</p>
<h1 id="then"><a href="#then" class="headerlink" title="then"></a>then</h1><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">$ cp <span class="regexp">/usr/</span>local<span class="regexp">/lib/</span>python2.<span class="number">7</span><span class="regexp">/site-packages/u</span>sr<span class="regexp">/local/</span>Cellar<span class="regexp">/python/</span><span class="number">2.7</span>.<span class="number">11</span><span class="regexp">/Frameworks/</span>Python.framework<span class="regexp">/Versions/</span><span class="number">2.7</span><span class="regexp">/lib/</span>python2.<span class="number">7</span><span class="regexp">/site-packages/</span>capstone<span class="regexp">/libcapstone.dylib /u</span>sr<span class="regexp">/local/</span>lib<span class="regexp">/python2.7/</span>site-packages<span class="regexp">/capstone/</span>libcapstone.dylib</span><br><span class="line">$ ropgadget</span><br><span class="line">Need a binary filename (--binary<span class="regexp">/--console or --help)</span></span><br></pre></td></tr></table></figure>
<p>已经可以正常使用了</p>
<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p>在kali rolling里试了一下<br>第二种方法行不通<br>只能用find<br>可以找到一个<code>/usr/lib/libcapstone.so.3</code><br>然后<br><code>cp /usr/lib/libcapstone.so.3 /usr/local/lib/python2.7/dist-packages/capstone/libcapstone.dylib</code><br>解决</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/09/hexo-scripts/" itemprop="url">
                  hexo-scripts
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-09T21:00:31+08:00" content="2016-03-09">
              2016-03-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/scripts/" itemprop="url" rel="index">
                    <span itemprop="name">scripts</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/09/hexo-scripts/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/09/hexo-scripts/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>偷师自<a href="http://www.xuxu1988.com/2015/05/16/config-my-hexo/" target="_blank" rel="external">http://www.xuxu1988.com/2015/05/16/config-my-hexo/</a></p>
<h1 id="commit-sh-COMMIT-LOG"><a href="#commit-sh-COMMIT-LOG" class="headerlink" title="./commit.sh COMMIT_LOG"></a>./commit.sh COMMIT_LOG</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">commit_<span class="built_in">log</span>=<span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">hexo g</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line">hexo d</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line">git commit -m <span class="variable">$commit_log</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line">git push origin hexo:hexo</span><br></pre></td></tr></table></figure>
<h1 id="edit-sh-FILENAME"><a href="#edit-sh-FILENAME" class="headerlink" title="./edit.sh FILENAME"></a>./edit.sh FILENAME</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span><br><span class="line"></span></span><br><span class="line">filename=<span class="variable">$@</span></span><br><span class="line">file=./<span class="built_in">source</span>/_posts/<span class="variable">$filename</span>.md</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! <span class="_">-e</span> <span class="string">"<span class="variable">$file</span>"</span> ]   <span class="comment"># NOT '$file'</span></span><br><span class="line"><span class="keyword">then</span> </span><br><span class="line">    hexo new <span class="variable">$filename</span></span><br><span class="line"><span class="keyword">fi</span> </span><br><span class="line"></span><br><span class="line">open <span class="_">-a</span> /Applications/MacDown.app <span class="variable">$file</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/09/hexo-github/" itemprop="url">
                  hexo github
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-09T19:08:03+08:00" content="2016-03-09">
              2016-03-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/09/hexo-github/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/09/hexo-github/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="hexo-amp-github"><a href="#hexo-amp-github" class="headerlink" title="hexo &amp; github"></a>hexo &amp; github</h1><p>一开始没有搞懂<code>.deploy_git</code>和<code>.git</code>的区别<br>后来发现<code>hexo deploy</code>到github上的内容只有纯粹的网页<br>才大致明白了hexo的工作流程</p>
<p>首先<br>hexo并没有生成页面文件<br>项目目录中除了配置文件以外就只有<code>hex new</code>出来的一些<code>.md</code>而已<br><code>hexo generate</code>之后才会在<code>public</code>目录下生成一系列html，css等页面文件   </p>
<p><code>hexo deploy</code>之后<br>hexo才会将所有页面文件push到项目的<code>master</code>分支(在<code>/_config.yml</code>中指定)上<br>网站因而得以运作   </p>
<p>但是这样一来<br>只有页面文件被放到了远程库<br>为了将配置文件和<code>.md</code>也放到Github<br>可以新建一个<code>hexo</code>分支来存放</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">git</span> checkout -<span class="keyword">b </span>hexo</span><br><span class="line"><span class="symbol">git</span> <span class="keyword">push </span>origin hexo:hexo</span><br></pre></td></tr></table></figure>
<p>这样一来<br>对hexo所做的修改也可以托管在Github上了</p>
<p>以后只需在<code>hexo g</code>生成页面后<br>先用<code>hexo d</code>发布到网站（即<code>master</code>分支）<br>然后<code>add</code>-<code>commit</code>-<code>push</code>所有改动到<code>hexo</code>分支   </p>
<h1 id="push-conflict"><a href="#push-conflict" class="headerlink" title="push conflict"></a>push conflict</h1><p>不过在实际的第二次push时<br>出现了冲突</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">$ git push origin hexo:hexo</span><br><span class="line">To git@github<span class="selector-class">.com</span>:answerrrrrrrrr/answerrrrrrrrr<span class="selector-class">.github</span><span class="selector-class">.com</span><span class="selector-class">.git</span></span><br><span class="line"> ! [rejected]        hexo -&gt; hexo (non-fast-forward)</span><br><span class="line">error: failed to push some refs to <span class="string">'git@github.com:answerrrrrrrrr/answerrrrrrrrr.github.com.git'</span></span><br><span class="line">hint: Updates were rejected because the tip of your current branch is behind</span><br><span class="line">hint: its remote counterpart. Integrate the remote changes (e<span class="selector-class">.g</span>.</span><br><span class="line">hint: <span class="string">'git pull ...'</span>) before pushing again.</span><br><span class="line">hint: See the <span class="string">'Note about fast-forwards'</span> <span class="keyword">in</span> <span class="string">'git push --help'</span> <span class="keyword">for</span> <span class="selector-tag">details</span>.</span><br></pre></td></tr></table></figure>
<p>参考<a href="http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/0013760174128707b935b0be6fc4fc6ace66c4f15618f8d000" target="_blank" rel="external">廖雪峰的文章</a>得以解决</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">$ git pull</span><br><span class="line">There is no tracking information for the current branch.</span><br><span class="line">Please specify which branch you want to <span class="keyword">merge</span> <span class="keyword">with</span>.</span><br><span class="line">See git-pull(<span class="number">1</span>) <span class="keyword">for</span> details</span><br><span class="line"></span><br><span class="line">    git pull &lt;remote&gt; &lt;branch&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> you wish <span class="keyword">to</span> <span class="keyword">set</span> <span class="keyword">tracking</span> information <span class="keyword">for</span> this branch you can <span class="keyword">do</span> so <span class="keyword">with</span>:</span><br><span class="line"></span><br><span class="line">    git branch <span class="comment">--set-upstream-to=origin/&lt;branch&gt; hexo</span></span><br><span class="line"></span><br><span class="line">$ git branch <span class="comment">--set-upstream hexo origin/hexo</span></span><br><span class="line">The <span class="comment">--set-upstream flag is deprecated and will be removed. Consider using --track or --set-upstream-to</span></span><br><span class="line">Branch hexo <span class="keyword">set</span> up <span class="keyword">to</span> track remote branch hexo <span class="keyword">from</span> origin.</span><br><span class="line"></span><br><span class="line">$ git pull</span><br><span class="line"><span class="keyword">Auto</span>-merging <span class="keyword">index</span>.html</span><br><span class="line">CONFLICT (<span class="keyword">add</span>/<span class="keyword">add</span>): <span class="keyword">Merge</span> conflict <span class="keyword">in</span> <span class="keyword">index</span>.html</span><br><span class="line"><span class="keyword">Automatic</span> <span class="keyword">merge</span> <span class="keyword">failed</span>; fix conflicts and then <span class="keyword">commit</span> the <span class="keyword">result</span>.</span><br><span class="line"></span><br><span class="line">$ git <span class="keyword">status</span></span><br><span class="line"><span class="keyword">On</span> branch hexo</span><br><span class="line">Your branch <span class="keyword">and</span> <span class="string">'origin/hexo'</span> have diverged,</span><br><span class="line"><span class="keyword">and</span> have <span class="number">1</span> <span class="keyword">and</span> <span class="number">1</span> different <span class="keyword">commit</span> <span class="keyword">each</span>, respectively.</span><br><span class="line">  (<span class="keyword">use</span> <span class="string">"git pull"</span> <span class="keyword">to</span> <span class="keyword">merge</span> the remote branch <span class="keyword">into</span> yours)</span><br><span class="line">You have unmerged paths.</span><br><span class="line">  (fix conflicts <span class="keyword">and</span> run <span class="string">"git commit"</span>)</span><br><span class="line"></span><br><span class="line">Unmerged paths:</span><br><span class="line">  (<span class="keyword">use</span> <span class="string">"git add &lt;file&gt;..."</span> <span class="keyword">to</span> mark resolution)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">both</span> added:      <span class="keyword">index</span>.html</span><br><span class="line"></span><br><span class="line"><span class="keyword">no</span> changes added <span class="keyword">to</span> <span class="keyword">commit</span> (<span class="keyword">use</span> <span class="string">"git add"</span> <span class="keyword">and</span>/<span class="keyword">or</span> <span class="string">"git commit -a"</span>)</span><br><span class="line"></span><br><span class="line">$ subl <span class="keyword">index</span>.html</span><br><span class="line">$ git <span class="keyword">add</span> .</span><br><span class="line">$ git <span class="keyword">commit</span> -m <span class="string">'index'</span></span><br><span class="line">	[hexo b7ed9be] <span class="keyword">index</span></span><br><span class="line">$ git push origin hexo:hexo</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/09/10-11-privoxy/" itemprop="url">
                  10.11 privoxy [Errno 61] Connection refused
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-03-09T15:33:31+08:00" content="2016-03-09">
              2016-03-09
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Mac/" itemprop="url" rel="index">
                    <span itemprop="name">Mac</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/09/10-11-privoxy/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/09/10-11-privoxy/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>自从更新10.11以来<br>之前用scrapy写的一个小爬虫就用不成了<br>总是报错<code>[Errno 61] Connection refused</code><br>但是因为不经常用也就没怎么上心<br>搜了一下sof<br>以为是网站做了防爬虫处理<br>但是折腾未果就去忙正经事了   </p>
<p>结果今天挂着代理<code>pip list --outdated</code>的时候<br>居然报了同样的<code>[Errno 61] Connection refused</code><br>才意识到可能是代理的问题</p>
<p>然而Shadowsocks一直使用正常<br>那问题就只可能出在Privoxy上了   </p>
<p>果然<code>lsof -i:8118</code>之后<br>发觉Privoxy居然没有绑在8118端口上<br>难怪会「Connection refused」。。。</p>
<p>Google之后<br><a href="http://www.andrewwatters.com/privoxy/" target="_blank" rel="external">这里</a>提到更新10.11需要重装Privoxy<br>那就重装吧。。。<br>在<a href="https://sourceforge.net/projects/ijbswa/files/" target="_blank" rel="external">SourceForge</a>下载最新版<br>然后按以往一样<br><code>sudo vim /usr/local/etc/privoxy/config</code><br>修改如下两行<br><code>listen-address  127.0.0.1:8118</code><br><code>forward-socks5t   /               127.0.0.1:1080 .</code><br>再启动Privoxy<br><code>sudo /Applications/Privoxy/startPrivoxy.sh</code><br>按以往经验<br>这时候应该就可以了<br>然而<code>lsof -i:8118</code>依然什么也没有   </p>
<p>在<a href="http://1992s.com/blog/share-shadowsocks-over-lan-on-mac-os-x.html" target="_blank" rel="external">这里</a>找到问题所在<br>启用修改后的配置<br><code>cd /usr/local/sbin/</code><br><code>./privoxy --no-daemon /usr/local/etc/privoxy/config</code>   </p>
<p>这时候<code>lsof -i:8118</code><br>终于见到了久违的Privoxy<br>然后爬虫也终于重生啦</p>
<p>另外<br>也是在<a href="http://1992s.com/blog/share-shadowsocks-over-lan-on-mac-os-x.html" target="_blank" rel="external">这里</a>发现可以用Privoxy来帮手机搭梯子<br>算是意外收获了~</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Air9" />
          <p class="site-author-name" itemprop="name">Air9</p>
          <p class="site-description motion-element" itemprop="description">なぜベストを尽くしたのか</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">36</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">73</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Air9</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"answerrrrrrrrr"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  


</body>
</html>
