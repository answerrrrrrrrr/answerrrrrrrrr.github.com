<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Answerrrrrrrrr" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="なぜベストを尽くしたのか">
<meta property="og:type" content="website">
<meta property="og:title" content="Answerrrrrrrrr">
<meta property="og:url" content="http://answerrrrrrrrr.io/page/2/index.html">
<meta property="og:site_name" content="Answerrrrrrrrr">
<meta property="og:description" content="なぜベストを尽くしたのか">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Answerrrrrrrrr">
<meta name="twitter:description" content="なぜベストを尽くしたのか">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Answerrrrrrrrr </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Answerrrrrrrrr</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/28/bootstrap-keyboard-tagIndex/" itemprop="url">
                  bootstrap-keyboard-tagIndex
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-06-28T16:16:57+08:00" content="2016-06-28">
              2016-06-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/28/bootstrap-keyboard-tagIndex/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/28/bootstrap-keyboard-tagIndex/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这两天在 Coursera 上学习 Bootstrap<br>第四周的作业是把非 JavaScript 实现的 Modal 改成用 JavaScript 实现（<a href="https://www.coursera.org/learn/web-frameworks/peer/jAXUU/assignment-4-detailed-instructions-and-submission）" target="_blank" rel="external">https://www.coursera.org/learn/web-frameworks/peer/jAXUU/assignment-4-detailed-instructions-and-submission）</a>   </p>
<p>按照 <a href="http://getbootstrap.com/javascript/#modals-methods" target="_blank" rel="external">http://getbootstrap.com/javascript/#modals-methods</a> 找到了解决方案：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $(<span class="string">'#reserveButton'</span>).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $(<span class="string">'#reserveModal'</span>).modal(<span class="string">'toggle'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"><span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>作业是解决了，但是发现一个小问题：不管我怎么改<code>keyboard</code>属性，都不能用<code>esc</code>关闭<code>modal</code></p>
<p>搜了一下得知：在<code>modal</code>所在<code>div</code>中加入<code>tabindex=&quot;-1&quot;</code>属性即可<br>那么问题又来了…这个<code>tabindex=&quot;-1&quot;</code>是什么鬼…   </p>
<p>搜索加测试了一下之后终于搞清楚了<br><code>tabindex</code>用来帮助键盘党使用<code>tab</code>键定位网页元素，按其值由小到大跳转，默认是 0<br>如果值相等，则按先后顺序跳转</p>
<p>在未加入<code>tabindex=&quot;-1&quot;</code>时，<code>modal</code>和主页中所有元素值都是 0<br>当前键盘的焦点仍然在主页而非<code>modal</code>上，相当于在主页按<code>esc</code>，<code>modal</code>监听不到所以无任何反应<br>加入<code>tabindex=&quot;-1&quot;</code>后，<code>modal</code>的优先级最高，键盘焦点到了<code>modal</code>上，这时再按<code>esc</code>就能正确触发关闭<code>modal</code>事件了</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://blog.163.com/huan12_8/blog/static/1305190902011274739628/" target="_blank" rel="external">http://blog.163.com/huan12_8/blog/static/1305190902011274739628/</a></li>
<li><a href="https://segmentfault.com/q/1010000004954562" target="_blank" rel="external">https://segmentfault.com/q/1010000004954562</a></li>
<li><a href="http://www.w3school.com.cn/tags/att_standard_tabindex.asp" target="_blank" rel="external">http://www.w3school.com.cn/tags/att_standard_tabindex.asp</a></li>
<li><a href="http://www.mamicode.com/info-detail-494399.html" target="_blank" rel="external">http://www.mamicode.com/info-detail-494399.html</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/06/16/git-push-error/" itemprop="url">
                  Permission denied (publickey)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-06-16T08:21:06+08:00" content="2016-06-16">
              2016-06-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/git/" itemprop="url" rel="index">
                    <span itemprop="name">git</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/16/git-push-error/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/06/16/git-push-error/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天把学习 flask 的本地库上传到 github 时报错</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">$ git push -u origin master</span><br><span class="line">Permission denied (publickey).</span><br><span class="line">fatal: Could <span class="keyword">not</span> <span class="built_in">read</span> <span class="built_in">from</span> remote repository.</span><br><span class="line"></span><br><span class="line">Please make sure you have <span class="keyword">the</span> correct access rights</span><br><span class="line"><span class="keyword">and</span> <span class="keyword">the</span> repository exists.</span><br></pre></td></tr></table></figure>
<p>在 <a href="http://stackoverflow.com/questions/26953071/github-authentication-failed-github-does-not-provide-shell-access" target="_blank" rel="external">stackoverflow</a> 找到解决方案</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">git remote set-url origin git@github<span class="selector-class">.com</span>:lut/EvolutionApp<span class="selector-class">.git</span></span><br><span class="line">git remote show origin</span><br></pre></td></tr></table></figure>
<p>简单记录一下…</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/25/python-cookbook-translator/" itemprop="url">
                  Python-Cookbook-1.09 简化 translate 方法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-25T21:46:44+08:00" content="2016-05-25">
              2016-05-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/25/python-cookbook-translator/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/25/python-cookbook-translator/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="string-maketrans"><a href="#string-maketrans" class="headerlink" title="string.maketrans"></a>string.maketrans</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Help</span> <span class="keyword">on</span> built-<span class="keyword">in</span> <span class="keyword">function</span> maketrans <span class="keyword">in</span> <span class="keyword">module</span> strop:</span><br><span class="line"></span><br><span class="line">maketrans(...)</span><br><span class="line">    maketrans(frm, <span class="keyword">to</span>) -&gt; <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Return</span> a <span class="keyword">translation</span> <span class="keyword">table</span> (a <span class="keyword">string</span> <span class="keyword">of</span> <span class="number">256</span> <span class="keyword">bytes</span> <span class="keyword">long</span>)</span><br><span class="line">    suitable <span class="keyword">for</span> <span class="keyword">use</span> <span class="keyword">in</span> <span class="keyword">string</span>.<span class="keyword">translate</span>.  The strings frm <span class="keyword">and</span> <span class="keyword">to</span></span><br><span class="line">    must be <span class="keyword">of</span> the same <span class="keyword">length</span>.</span><br><span class="line">(<span class="keyword">END</span>)</span><br></pre></td></tr></table></figure>
<p>生成一个供<code>string.translate</code>使用的 ASCII 表，其中<code>frm</code>中的所有字符都依序被替换成<code>to</code>中字符：</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; maketrans('abc', 'fed')</span><br><span class="line">'<span class="tag">\<span class="name">x</span></span>00<span class="tag">\<span class="name">x</span></span>01<span class="tag">\<span class="name">x</span></span>02<span class="tag">\<span class="name">x</span></span>03<span class="tag">\<span class="name">x</span></span>04<span class="tag">\<span class="name">x</span></span>05<span class="tag">\<span class="name">x</span></span>06<span class="tag">\<span class="name">x</span></span>07<span class="tag">\<span class="name">x</span></span>08<span class="tag">\<span class="name">t</span></span><span class="tag">\<span class="name">n</span></span><span class="tag">\<span class="name">x</span></span>0b<span class="tag">\<span class="name">x</span></span>0c<span class="tag">\<span class="name">r</span></span><span class="tag">\<span class="name">x</span></span>0e<span class="tag">\<span class="name">x</span></span>0f<span class="tag">\<span class="name">x</span></span>10<span class="tag">\<span class="name">x</span></span>11<span class="tag">\<span class="name">x</span></span>12<span class="tag">\<span class="name">x</span></span>13<span class="tag">\<span class="name">x</span></span>14<span class="tag">\<span class="name">x</span></span>15<span class="tag">\<span class="name">x</span></span>16<span class="tag">\<span class="name">x</span></span>17<span class="tag">\<span class="name">x</span></span>18<span class="tag">\<span class="name">x</span></span>19<span class="tag">\<span class="name">x</span></span>1a<span class="tag">\<span class="name">x</span></span>1b<span class="tag">\<span class="name">x</span></span>1c<span class="tag">\<span class="name">x</span></span>1d<span class="tag">\<span class="name">x</span></span>1e<span class="tag">\<span class="name">x</span></span>1f !"#<span class="formula">$%&amp;<span class="tag">\<span class="name">'</span></span>()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[<span class="tag">\<span class="name">\</span></span>]^_`feddefghijklmnopqrstuvwxyz&#123;|&#125;~<span class="tag">\<span class="name">x</span></span>7f<span class="tag">\<span class="name">x</span></span>80<span class="tag">\<span class="name">x</span></span>81<span class="tag">\<span class="name">x</span></span>82<span class="tag">\<span class="name">x</span></span>83<span class="tag">\<span class="name">x</span></span>84<span class="tag">\<span class="name">x</span></span>85<span class="tag">\<span class="name">x</span></span>86<span class="tag">\<span class="name">x</span></span>87<span class="tag">\<span class="name">x</span></span>88<span class="tag">\<span class="name">x</span></span>89<span class="tag">\<span class="name">x</span></span>8a<span class="tag">\<span class="name">x</span></span>8b<span class="tag">\<span class="name">x</span></span>8c<span class="tag">\<span class="name">x</span></span>8d<span class="tag">\<span class="name">x</span></span>8e<span class="tag">\<span class="name">x</span></span>8f<span class="tag">\<span class="name">x</span></span>90<span class="tag">\<span class="name">x</span></span>91<span class="tag">\<span class="name">x</span></span>92<span class="tag">\<span class="name">x</span></span>93<span class="tag">\<span class="name">x</span></span>94<span class="tag">\<span class="name">x</span></span>95<span class="tag">\<span class="name">x</span></span>96<span class="tag">\<span class="name">x</span></span>97<span class="tag">\<span class="name">x</span></span>98<span class="tag">\<span class="name">x</span></span>99<span class="tag">\<span class="name">x</span></span>9a<span class="tag">\<span class="name">x</span></span>9b<span class="tag">\<span class="name">x</span></span>9c<span class="tag">\<span class="name">x</span></span>9d<span class="tag">\<span class="name">x</span></span>9e<span class="tag">\<span class="name">x</span></span>9f<span class="tag">\<span class="name">xa</span></span>0<span class="tag">\<span class="name">xa</span></span>1<span class="tag">\<span class="name">xa</span></span>2<span class="tag">\<span class="name">xa</span></span>3<span class="tag">\<span class="name">xa</span></span>4<span class="tag">\<span class="name">xa</span></span>5<span class="tag">\<span class="name">xa</span></span>6<span class="tag">\<span class="name">xa</span></span>7<span class="tag">\<span class="name">xa</span></span>8<span class="tag">\<span class="name">xa</span></span>9<span class="tag">\<span class="name">xaa</span></span><span class="tag">\<span class="name">xab</span></span><span class="tag">\<span class="name">xac</span></span><span class="tag">\<span class="name">xad</span></span><span class="tag">\<span class="name">xae</span></span><span class="tag">\<span class="name">xaf</span></span><span class="tag">\<span class="name">xb</span></span>0<span class="tag">\<span class="name">xb</span></span>1<span class="tag">\<span class="name">xb</span></span>2<span class="tag">\<span class="name">xb</span></span>3<span class="tag">\<span class="name">xb</span></span>4<span class="tag">\<span class="name">xb</span></span>5<span class="tag">\<span class="name">xb</span></span>6<span class="tag">\<span class="name">xb</span></span>7<span class="tag">\<span class="name">xb</span></span>8<span class="tag">\<span class="name">xb</span></span>9<span class="tag">\<span class="name">xba</span></span><span class="tag">\<span class="name">xbb</span></span><span class="tag">\<span class="name">xbc</span></span><span class="tag">\<span class="name">xbd</span></span><span class="tag">\<span class="name">xbe</span></span><span class="tag">\<span class="name">xbf</span></span><span class="tag">\<span class="name">xc</span></span>0<span class="tag">\<span class="name">xc</span></span>1<span class="tag">\<span class="name">xc</span></span>2<span class="tag">\<span class="name">xc</span></span>3<span class="tag">\<span class="name">xc</span></span>4<span class="tag">\<span class="name">xc</span></span>5<span class="tag">\<span class="name">xc</span></span>6<span class="tag">\<span class="name">xc</span></span>7<span class="tag">\<span class="name">xc</span></span>8<span class="tag">\<span class="name">xc</span></span>9<span class="tag">\<span class="name">xca</span></span><span class="tag">\<span class="name">xcb</span></span><span class="tag">\<span class="name">xcc</span></span><span class="tag">\<span class="name">xcd</span></span><span class="tag">\<span class="name">xce</span></span><span class="tag">\<span class="name">xcf</span></span><span class="tag">\<span class="name">xd</span></span>0<span class="tag">\<span class="name">xd</span></span>1<span class="tag">\<span class="name">xd</span></span>2<span class="tag">\<span class="name">xd</span></span>3<span class="tag">\<span class="name">xd</span></span>4<span class="tag">\<span class="name">xd</span></span>5<span class="tag">\<span class="name">xd</span></span>6<span class="tag">\<span class="name">xd</span></span>7<span class="tag">\<span class="name">xd</span></span>8<span class="tag">\<span class="name">xd</span></span>9<span class="tag">\<span class="name">xda</span></span><span class="tag">\<span class="name">xdb</span></span><span class="tag">\<span class="name">xdc</span></span><span class="tag">\<span class="name">xdd</span></span><span class="tag">\<span class="name">xde</span></span><span class="tag">\<span class="name">xdf</span></span><span class="tag">\<span class="name">xe</span></span>0<span class="tag">\<span class="name">xe</span></span>1<span class="tag">\<span class="name">xe</span></span>2<span class="tag">\<span class="name">xe</span></span>3<span class="tag">\<span class="name">xe</span></span>4<span class="tag">\<span class="name">xe</span></span>5<span class="tag">\<span class="name">xe</span></span>6<span class="tag">\<span class="name">xe</span></span>7<span class="tag">\<span class="name">xe</span></span>8<span class="tag">\<span class="name">xe</span></span>9<span class="tag">\<span class="name">xea</span></span><span class="tag">\<span class="name">xeb</span></span><span class="tag">\<span class="name">xec</span></span><span class="tag">\<span class="name">xed</span></span><span class="tag">\<span class="name">xee</span></span><span class="tag">\<span class="name">xef</span></span><span class="tag">\<span class="name">xf</span></span>0<span class="tag">\<span class="name">xf</span></span>1<span class="tag">\<span class="name">xf</span></span>2<span class="tag">\<span class="name">xf</span></span>3<span class="tag">\<span class="name">xf</span></span>4<span class="tag">\<span class="name">xf</span></span>5<span class="tag">\<span class="name">xf</span></span>6<span class="tag">\<span class="name">xf</span></span>7<span class="tag">\<span class="name">xf</span></span>8<span class="tag">\<span class="name">xf</span></span>9<span class="tag">\<span class="name">xfa</span></span><span class="tag">\<span class="name">xfb</span></span><span class="tag">\<span class="name">xfc</span></span><span class="tag">\<span class="name">xfd</span></span><span class="tag">\<span class="name">xfe</span></span><span class="tag">\<span class="name">xff</span></span>'</span><br><span class="line">&gt;&gt;&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="string-translate"><a href="#string-translate" class="headerlink" title="string.translate"></a>string.translate</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Help</span> <span class="keyword">on</span> <span class="keyword">function</span> <span class="keyword">translate</span> <span class="keyword">in</span> <span class="keyword">module</span> <span class="keyword">string</span>:</span><br><span class="line"></span><br><span class="line"><span class="keyword">translate</span>(s, <span class="keyword">table</span>, deletions=<span class="string">''</span>)</span><br><span class="line">    <span class="keyword">translate</span>(s,<span class="keyword">table</span> [,deletions]) -&gt; <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">Return</span> a copy <span class="keyword">of</span> the <span class="keyword">string</span> s, <span class="keyword">where</span> all <span class="keyword">characters</span> occurring</span><br><span class="line">    <span class="keyword">in</span> the optional argument deletions <span class="keyword">are</span> removed, <span class="keyword">and</span> the</span><br><span class="line">    remaining <span class="keyword">characters</span> have been mapped <span class="keyword">through</span> the given</span><br><span class="line">    <span class="keyword">translation</span> <span class="keyword">table</span>, which must be a <span class="keyword">string</span> <span class="keyword">of</span> <span class="keyword">length</span> <span class="number">256.</span>  The</span><br><span class="line">    deletions argument <span class="keyword">is</span> <span class="keyword">not</span> allowed <span class="keyword">for</span> <span class="keyword">Unicode</span> strings.</span><br><span class="line">(<span class="keyword">END</span>)</span><br></pre></td></tr></table></figure>
<p>(也可以<code>s.translate(table, deletions=&#39;&#39;)</code>为格式）</p>
<p>以<code>maketrans</code>生成的映射表为基准进行字符转换：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; translate(<span class="string">'abcdef'</span>, a)</span><br><span class="line"><span class="string">'feddef'</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; translate(<span class="string">'abcdef'</span>, a, <span class="string">'d'</span>)</span><br><span class="line"><span class="string">'fedef'</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; translate(<span class="string">'abcdef'</span>, a, <span class="string">'dd'</span>)</span><br><span class="line"><span class="string">'fedef'</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; translate(<span class="string">'abcdef'</span>, a, <span class="string">'de'</span>)</span><br><span class="line"><span class="string">'fedf'</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; translate(<span class="string">'abcdef'</span>, a, <span class="string">'ade'</span>)</span><br><span class="line"><span class="string">'edf'</span></span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt;</span><br></pre></td></tr></table></figure>
<h1 id="自建一个返回闭包的工厂函数-translator"><a href="#自建一个返回闭包的工厂函数-translator" class="headerlink" title="自建一个返回闭包的工厂函数 translator"></a>自建一个返回闭包的工厂函数 translator</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">translator</span><span class="params">(frm=<span class="string">''</span>, to=<span class="string">''</span>, delete=<span class="string">''</span>, keep=None)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> len(to) == <span class="number">1</span>:</span><br><span class="line">        to = to * len(frm)</span><br><span class="line">    trans = string.maketrans(frm, to)</span><br><span class="line">    <span class="keyword">if</span> keep <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        allchars = string.maketrans(<span class="string">''</span>, <span class="string">''</span>)</span><br><span class="line">        delete = allchars.translate(allchars, keep.translate(allchars, delete))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">translate</span><span class="params">(s)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> s.translate(trans, delete)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> translate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    digits_only = translator(keep=string.digits)</span><br><span class="line">    <span class="keyword">print</span> digits_only(<span class="string">'qwedwefaf24215'</span>)</span><br><span class="line"></span><br><span class="line">    no_digits = translator(delete=string.digits)</span><br><span class="line">    <span class="keyword">print</span> no_digits(<span class="string">'qwedwefaf24215'</span>)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/19/Python-sorted函数中key的用法/" itemprop="url">
                  Python-sorted函数中key的用法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-19T09:02:08+08:00" content="2016-05-19">
              2016-05-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/19/Python-sorted函数中key的用法/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/19/Python-sorted函数中key的用法/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>sorted函数的可用参数如下</p>
<blockquote>
<p>sorted(iterable[, cmp[, key[, reverse]]])</p>
</blockquote>
<p>其它几个还好理解，就是<code>key</code>的用法经常会忘记，所以记录一下备用</p>
<p><a href="http://devdocs.io/python~2.7/library/functions#sorted" target="_blank" rel="external">文档</a>中说：</p>
<blockquote>
<p>key specifies a function of one argument that is used to extract a comparison key from each list element: key=str.lower. The default value is None (compare the elements directly).</p>
</blockquote>
<p>我的理解是<br><code>key</code>提供了一个函数，以<code>iterable</code>对象中的元素为唯一参数，返回一个与原元素一一对应的 key 值<br>然后再对以这些 key 值为元素的<code>iterable</code>进行排序<br>最后将这些 key 值替换回对应的原元素<br>排序完成</p>
<p>需要注意的就是<code>False &lt; True</code></p>
<p>然后是实例（参考<a href="https://segmentfault.com/q/1010000005111826/a-1020000005112829）" target="_blank" rel="external">https://segmentfault.com/q/1010000005111826/a-1020000005112829）</a></p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">s = <span class="string">'aB23'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sorted_with_key</span><span class="params">(s, key)</span>:</span></span><br><span class="line">    s = sorted(s, key=key)</span><br><span class="line">    <span class="keyword">print</span> s</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'keys: '</span>,</span><br><span class="line">    <span class="keyword">print</span> [key(x) <span class="keyword">for</span> x <span class="keyword">in</span> s]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'\nstr.lower'</span></span><br><span class="line">sorted_with_key(s, str.lower)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'\nstr.islower'</span></span><br><span class="line">sorted_with_key(s, str.islower)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'\nlambda x: x.isdigit() and int(x) % 2 == 0'</span></span><br><span class="line">sorted_with_key(s, <span class="keyword">lambda</span> x: x.isdigit() <span class="keyword">and</span> int(x) % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'\nlambda x: x.isdigit(), x.isdigit() and int(x) % 2==0, x.isupper(), x.islower(), x'</span></span><br><span class="line"><span class="comment"># 排序:小写-大写-奇数-偶数</span></span><br><span class="line">sorted_with_key(s, <span class="keyword">lambda</span> x: (x.isdigit(), x.isdigit() <span class="keyword">and</span> int(x) %</span><br><span class="line">                              <span class="number">2</span> == <span class="number">0</span>, x.isupper(), x.islower(), x))</span><br></pre></td></tr></table></figure>
<p>output</p>
<figure class="highlight autoit"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">str.lower</span><br><span class="line">[<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'a'</span>, <span class="string">'B'</span>]</span><br><span class="line">keys:  [<span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>]</span><br><span class="line"></span><br><span class="line">str.islower</span><br><span class="line">[<span class="string">'B'</span>, <span class="string">'2'</span>, <span class="string">'3'</span>, <span class="string">'a'</span>]</span><br><span class="line">keys:  [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">True</span>]</span><br><span class="line"></span><br><span class="line">lambda x: x.isdigit() <span class="literal">and</span> <span class="built_in">int</span>(x) % <span class="number">2</span> == <span class="number">0</span></span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'B'</span>, <span class="string">'3'</span>, <span class="string">'2'</span>]</span><br><span class="line">keys:  [<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">True</span>]</span><br><span class="line"></span><br><span class="line">lambda x: (x.isdigit(), x.isdigit() <span class="literal">and</span> <span class="built_in">int</span>(x) % <span class="number">2</span>==<span class="number">0</span>, x.isupper(), x.islower(), x)</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'B'</span>, <span class="string">'3'</span>, <span class="string">'2'</span>]</span><br><span class="line">keys:  [(<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">True</span>, <span class="string">'a'</span>), (<span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">True</span>, <span class="literal">False</span>, <span class="string">'B'</span>), (<span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="string">'3'</span>), (<span class="literal">True</span>, <span class="literal">True</span>, <span class="literal">False</span>, <span class="literal">False</span>, <span class="string">'2'</span>)]</span><br></pre></td></tr></table></figure>
<h1 id="2016-7-9-补充"><a href="#2016-7-9-补充" class="headerlink" title="2016.7.9 补充"></a>2016.7.9 补充</h1><p>今天看了 cookbook 5.2，Python 2.4 之前是不支持<code>key</code>的，书中提供了一个类似的思路，感觉对理解<code>key</code>的实现很有帮助，摘录如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">case_insensitive_sorted</span><span class="params">(string_list)</span>:</span></span><br><span class="line">    auxiliary_list = [(x.lower(), x) <span class="keyword">for</span> x <span class="keyword">in</span> string_list] <span class="comment"># decorate</span></span><br><span class="line">    auxiliary_list.sort()                                  <span class="comment"># sort</span></span><br><span class="line">    <span class="keyword">return</span> [x[<span class="number">1</span>] <span class="keyword">for</span> x <span class="keyword">in</span> auxiliary_list]                  <span class="comment"># undecorate</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/16/Flask-数据库更新问题/" itemprop="url">
                  Flask 数据库更新问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-05-16T21:52:45+08:00" content="2016-05-16">
              2016-05-16
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Flask/" itemprop="url" rel="index">
                    <span itemprop="name">Flask</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/05/16/Flask-数据库更新问题/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/05/16/Flask-数据库更新问题/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="更新列"><a href="#更新列" class="headerlink" title="更新列"></a>更新列</h1><h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>学习到 8.4.6 测试登录时</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">(venv) $ python manage<span class="selector-class">.py</span> shell </span><br><span class="line">&gt;&gt;&gt; u = User(email=<span class="string">'john@example.com'</span>, username=<span class="string">'john'</span>, password=<span class="string">'cat'</span>) </span><br><span class="line">&gt;&gt;&gt; db<span class="selector-class">.session</span><span class="selector-class">.add</span>(u) </span><br><span class="line">&gt;&gt;&gt; db<span class="selector-class">.session</span><span class="selector-class">.commit</span>()</span><br></pre></td></tr></table></figure>
<p>报错说表中无 email 列</p>
<p>确认代码无误后，判断应该是没有成功更新 models.py 中新建的 email 列，简单尝试无果，决定重新看一遍相关内容加深理解，再着手解决</p>
<h2 id="粗暴的更新方法"><a href="#粗暴的更新方法" class="headerlink" title="粗暴的更新方法"></a>粗暴的更新方法</h2><p>如果数据库表已经存在于数据库中， 那么 db.create_all() 不会重新创建或者更新这个表。如果修改模型后要把改动应用到现有的数据库中，这一特 性会带来不便。更新现有数据库表的粗暴方式是先删除旧表再重新创建：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; db.drop_all() </span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; db.create_all()</span><br></pre></td></tr></table></figure>
<h2 id="使用-Flask-Migrate-实现数据库迁移"><a href="#使用-Flask-Migrate-实现数据库迁移" class="headerlink" title="使用 Flask-Migrate 实现数据库迁移"></a>使用 Flask-Migrate 实现数据库迁移</h2><blockquote>
<p>更新表的更好方法是使用数据库迁移框架。源码版本控制工具可以跟踪源码文件的变化， 类似地，数据库迁移框架能跟踪数据库模式的变化，然后增量式的把变化应用到数据库中。</p>
<p>SQLAlchemy 的主力开发人员编写了一个迁移框架，称为 Alembic（<a href="https://alembic.readthedocs" target="_blank" rel="external">https://alembic.readthedocs</a>. org/en/latest/index.html） 。 除 了 直 接 使 用 Alembic 之 外， Flask 程 序 还 可 使 用 Flask-Migrate （<a href="http://flask-migrate.readthedocs.org/en/latest/）扩展。这个扩展对" target="_blank" rel="external">http://flask-migrate.readthedocs.org/en/latest/）扩展。这个扩展对</a> Alembic 做了轻量级包装，并 集成到 Flask-Script 中，所有操作都通过 Flask-Script 命令完成。</p>
</blockquote>
<p>安装与配置略过不提<br>几次尝试后，方才对几个主要命令的实际作用有了正确的理解</p>
<h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><p>创建迁移仓库和脚本，并不会生成或更新数据库文件，<code>migrations/versions/</code>中为空，如果此时<code>upgrade</code>会生成一个只包含<code>alembic_version</code>表的数据库</p>
<figure class="highlight hsp"><table><tr><td class="code"><pre><span class="line">$ sqlite3 data-dev.sqlite</span><br><span class="line">SQLite version <span class="number">3.8</span><span class="number">.10</span><span class="number">.2</span> <span class="number">2015</span><span class="number">-05</span><span class="number">-20</span> <span class="number">18</span>:<span class="number">17</span>:<span class="number">19</span></span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> usage hints.</span><br><span class="line">sqlite&gt; .dump</span><br><span class="line">PRAGMA foreign_keys=OFF<span class="comment">;</span></span><br><span class="line">BEGIN TRANSACTION<span class="comment">;</span></span><br><span class="line">CREATE TABLE alembic_version (</span><br><span class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> NULL</span><br><span class="line">)<span class="comment">;</span></span><br><span class="line">COMMIT<span class="comment">;</span></span><br><span class="line">sqlite&gt;</span><br></pre></td></tr></table></figure>
<h3 id="migrate"><a href="#migrate" class="headerlink" title="migrate"></a>migrate</h3><p>检测对数据库的操作，生成迁移脚本保存到<code>migrations/versions/</code>中，用于数据库迁移</p>
<p>不过按<a href="http://flask-migrate.readthedocs.io/en/latest/" target="_blank" rel="external">官方文档</a>所说，不一定能检测到所有对数据库的修改，所有需要自己对生成的迁移脚本进行检查，加上可能有遗漏的地方</p>
<h3 id="upgrade"><a href="#upgrade" class="headerlink" title="upgrade"></a>upgrade</h3><p>用于把上述迁移运用到数据库中，即至此才会真正对数据库进行更新</p>
<figure class="highlight gauss"><table><tr><td class="code"><pre><span class="line">$ sqlite3 data-dev.sqlite</span><br><span class="line">SQLite version <span class="number">3.8</span><span class="number">.10</span><span class="number">.2</span> <span class="number">2015</span><span class="number">-05</span><span class="number">-20</span> <span class="number">18</span>:<span class="number">17</span>:<span class="number">19</span></span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> usage hints.</span><br><span class="line">sqlite&gt; .dump</span><br><span class="line">PRAGMA foreign_keys=OFF;</span><br><span class="line">BEGIN TRANSACTION;</span><br><span class="line"><span class="keyword">CREATE</span> TABLE alembic_version (</span><br><span class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="built_in">NULL</span></span><br><span class="line">);</span><br><span class="line">INSERT INTO <span class="string">"alembic_version"</span> VALUES('bb488872a057');</span><br><span class="line"><span class="keyword">CREATE</span> TABLE roles (</span><br><span class="line">	id INTEGER <span class="keyword">NOT</span> <span class="built_in">NULL</span>,</span><br><span class="line">	name VARCHAR(<span class="number">64</span>),</span><br><span class="line">	PRIMARY <span class="built_in">KEY</span> (id),</span><br><span class="line">	<span class="built_in">UNIQUE</span> (name)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">CREATE</span> TABLE users (</span><br><span class="line">	id INTEGER <span class="keyword">NOT</span> <span class="built_in">NULL</span>,</span><br><span class="line">	email VARCHAR(<span class="number">64</span>),</span><br><span class="line">	username VARCHAR(<span class="number">64</span>),</span><br><span class="line">	role_id INTEGER,</span><br><span class="line">	password_hash VARCHAR(<span class="number">128</span>),</span><br><span class="line">	PRIMARY <span class="built_in">KEY</span> (id),</span><br><span class="line">	FOREIGN <span class="built_in">KEY</span>(role_id) REFERENCES roles (id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="built_in">UNIQUE</span> INDEX ix_users_email ON users (email);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="built_in">UNIQUE</span> INDEX ix_users_username ON users (username);</span><br><span class="line">COMMIT;</span><br><span class="line">sqlite&gt;</span><br></pre></td></tr></table></figure>
<h1 id="管理员角色"><a href="#管理员角色" class="headerlink" title="管理员角色"></a>管理员角色</h1><h2 id="遇到的问题-1"><a href="#遇到的问题-1" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><p>学习到 10.3.2后，发现以管理员邮箱注册的帐号并不能打开<code>管理员级别的资料编辑器</code><br>手动查看数据库：<br><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">"users"</span> <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'huamingrui@163.com'</span>,<span class="string">'huamingrui'</span>,<span class="literal">NULL</span>,<span class="string">'pbkdf2:sha1:1000$wpqGMEz8$a3bf86fcb0be120a7510a8f702077eb2fdfa1980'</span>,<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="string">'2016-05-17 14:17:48.930851'</span>,<span class="string">'2016-05-17 14:19:00.735339'</span>);</span><br></pre></td></tr></table></figure></p>
<p>发现<code>role_id</code>项为空，即角色没有被成功赋予</p>
<h2 id="Role-insert-roles"><a href="#Role-insert-roles" class="headerlink" title="Role.insert_roles()"></a>Role.insert_roles()</h2><p>回去翻书，找到 9.3 最后的部分说到</p>
<blockquote>
<p>在你阅读下一章之前，最好重新创建或者更新开发数据库，如此一来，那些在实现角色和 权限之前创建的用户账户就被赋予了角色。</p>
</blockquote>
<p>然而实测发现，对于管理员用户，必须在注册之前就完成 9.1 最后的<code>Role.insert_roles()</code>步骤，才能成功为管理员邮箱用户赋予<code>管理员角色</code></p>
<figure class="highlight vbnet"><table><tr><td class="code"><pre><span class="line">$ rm data-dev.sqlite</span><br><span class="line">$ python manage.py db upgrade</span><br><span class="line">INFO  [alembic.runtime.migration] Context impl SQLiteImpl.</span><br><span class="line">INFO  [alembic.runtime.migration] Will assume non-transactional DDL.</span><br><span class="line">INFO  [alembic.runtime.migration] Running upgrade  -&gt; <span class="number">02</span>ccb3e6a553, empty message</span><br><span class="line">$ sqlite3 data-dev.sqlite</span><br><span class="line">SQLite version <span class="number">3.8</span><span class="number">.10</span><span class="number">.2</span> <span class="number">2015</span><span class="number">-05</span><span class="number">-20</span> <span class="number">18</span>:<span class="number">17</span>:<span class="number">19</span></span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> usage hints.</span><br><span class="line">sqlite&gt; .dump</span><br><span class="line">PRAGMA foreign_keys=<span class="keyword">OFF</span>;</span><br><span class="line">BEGIN TRANSACTION;</span><br><span class="line">CREATE TABLE alembic_version (</span><br><span class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> NULL</span><br><span class="line">);</span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"alembic_version"</span> VALUES(<span class="comment">'02ccb3e6a553');</span></span><br><span class="line">CREATE TABLE roles (</span><br><span class="line">	id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> NULL,</span><br><span class="line">	name VARCHAR(<span class="number">64</span>),</span><br><span class="line">	<span class="string">"default"</span> <span class="built_in">BOOLEAN</span>,</span><br><span class="line">	permissions <span class="built_in">INTEGER</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (id),</span><br><span class="line">	UNIQUE (name),</span><br><span class="line">	CHECK (<span class="string">"default"</span> <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">);</span><br><span class="line">CREATE TABLE users (</span><br><span class="line">	id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> NULL,</span><br><span class="line">	email VARCHAR(<span class="number">64</span>),</span><br><span class="line">	username VARCHAR(<span class="number">64</span>),</span><br><span class="line">	role_id <span class="built_in">INTEGER</span>,</span><br><span class="line">	password_hash VARCHAR(<span class="number">128</span>),</span><br><span class="line">	confirmed <span class="built_in">BOOLEAN</span>,</span><br><span class="line">	name VARCHAR(<span class="number">64</span>),</span><br><span class="line">	location VARCHAR(<span class="number">64</span>),</span><br><span class="line">	about_me <span class="keyword">TEXT</span>,</span><br><span class="line">	member_since DATETIME,</span><br><span class="line">	last_seen DATETIME,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (id),</span><br><span class="line">	FOREIGN <span class="keyword">KEY</span>(role_id) REFERENCES roles (id),</span><br><span class="line">	CHECK (confirmed <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">);</span><br><span class="line">CREATE INDEX ix_roles_default <span class="keyword">ON</span> roles (<span class="string">"default"</span>);</span><br><span class="line">CREATE UNIQUE INDEX ix_users_email <span class="keyword">ON</span> users (email);</span><br><span class="line">CREATE UNIQUE INDEX ix_users_username <span class="keyword">ON</span> users (username);</span><br><span class="line">COMMIT;</span><br><span class="line">sqlite&gt; ^D</span><br><span class="line">$ python manage.py shell</span><br><span class="line">&gt;&gt;&gt; Role.insert_roles()</span><br><span class="line">&gt;&gt;&gt; Role.query.all()</span><br><span class="line">[&lt;Role u<span class="comment">'Moderator'&gt;, <span class="doctag">&lt;Role u'Administrator'&gt;</span>, <span class="doctag">&lt;Role u'User'&gt;</span>]</span></span><br><span class="line">&gt;&gt;&gt; ^D</span><br><span class="line">$ sqlite3 data-dev.sqlite</span><br><span class="line">SQLite version <span class="number">3.8</span><span class="number">.10</span><span class="number">.2</span> <span class="number">2015</span><span class="number">-05</span><span class="number">-20</span> <span class="number">18</span>:<span class="number">17</span>:<span class="number">19</span></span><br><span class="line">Enter <span class="string">".help"</span> <span class="keyword">for</span> usage hints.</span><br><span class="line">sqlite&gt; .dump</span><br><span class="line">PRAGMA foreign_keys=<span class="keyword">OFF</span>;</span><br><span class="line">BEGIN TRANSACTION;</span><br><span class="line">CREATE TABLE alembic_version (</span><br><span class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> NULL</span><br><span class="line">);</span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"alembic_version"</span> VALUES(<span class="comment">'02ccb3e6a553');</span></span><br><span class="line">CREATE TABLE roles (</span><br><span class="line">	id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> NULL,</span><br><span class="line">	name VARCHAR(<span class="number">64</span>),</span><br><span class="line">	<span class="string">"default"</span> <span class="built_in">BOOLEAN</span>,</span><br><span class="line">	permissions <span class="built_in">INTEGER</span>,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (id),</span><br><span class="line">	UNIQUE (name),</span><br><span class="line">	CHECK (<span class="string">"default"</span> <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">);</span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"roles"</span> VALUES(<span class="number">1</span>,<span class="comment">'Moderator',0,15);</span></span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"roles"</span> VALUES(<span class="number">2</span>,<span class="comment">'Administrator',0,255);</span></span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"roles"</span> VALUES(<span class="number">3</span>,<span class="comment">'User',1,7);</span></span><br><span class="line">CREATE TABLE users (</span><br><span class="line">	id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> NULL,</span><br><span class="line">	email VARCHAR(<span class="number">64</span>),</span><br><span class="line">	username VARCHAR(<span class="number">64</span>),</span><br><span class="line">	role_id <span class="built_in">INTEGER</span>,</span><br><span class="line">	password_hash VARCHAR(<span class="number">128</span>),</span><br><span class="line">	confirmed <span class="built_in">BOOLEAN</span>,</span><br><span class="line">	name VARCHAR(<span class="number">64</span>),</span><br><span class="line">	location VARCHAR(<span class="number">64</span>),</span><br><span class="line">	about_me <span class="keyword">TEXT</span>,</span><br><span class="line">	member_since DATETIME,</span><br><span class="line">	last_seen DATETIME,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (id),</span><br><span class="line">	FOREIGN <span class="keyword">KEY</span>(role_id) REFERENCES roles (id),</span><br><span class="line">	CHECK (confirmed <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">);</span><br><span class="line">CREATE INDEX ix_roles_default <span class="keyword">ON</span> roles (<span class="string">"default"</span>);</span><br><span class="line">CREATE UNIQUE INDEX ix_users_email <span class="keyword">ON</span> users (email);</span><br><span class="line">CREATE UNIQUE INDEX ix_users_username <span class="keyword">ON</span> users (username);</span><br><span class="line">COMMIT;</span><br><span class="line">sqlite&gt; ^D</span><br><span class="line">$ python manage.py runserver</span><br></pre></td></tr></table></figure>
<p>注册管理员邮箱<br><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line">$ sqlite3 <span class="built_in">data</span><span class="attr">-dev</span>.sqlite</span><br><span class="line">SQLite version <span class="number">3.8</span><span class="number">.10</span><span class="number">.2</span> <span class="number">2015</span><span class="number">-05</span><span class="number">-20</span> <span class="number">18</span>:<span class="number">17</span>:<span class="number">19</span></span><br><span class="line">Enter <span class="string">".help"</span> for usage hints.</span><br><span class="line">sqlite&gt; .dump</span><br><span class="line">PRAGMA foreign_keys=OFF;</span><br><span class="line">BEGIN TRANSACTION;</span><br><span class="line">CREATE TABLE alembic_version (</span><br><span class="line">	version_num VARCHAR(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="built_in">NULL</span></span><br><span class="line">);</span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"alembic_version"</span> VALUES(<span class="string">'02ccb3e6a553'</span>);</span><br><span class="line">CREATE TABLE roles (</span><br><span class="line">	id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="built_in">NULL</span>,</span><br><span class="line">	name VARCHAR(<span class="number">64</span>),</span><br><span class="line">	<span class="string">"default"</span> <span class="built_in">BOOLEAN</span>,</span><br><span class="line">	permissions <span class="built_in">INTEGER</span>,</span><br><span class="line">	PRIMARY KEY (id),</span><br><span class="line">	UNIQUE (name),</span><br><span class="line">	CHECK (<span class="string">"default"</span> <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">);</span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"roles"</span> VALUES(<span class="number">1</span>,<span class="string">'Moderator'</span>,<span class="number">0</span>,<span class="number">15</span>);</span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"roles"</span> VALUES(<span class="number">2</span>,<span class="string">'Administrator'</span>,<span class="number">0</span>,<span class="number">255</span>);</span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"roles"</span> VALUES(<span class="number">3</span>,<span class="string">'User'</span>,<span class="number">1</span>,<span class="number">7</span>);</span><br><span class="line">CREATE TABLE users (</span><br><span class="line">	id <span class="built_in">INTEGER</span> <span class="keyword">NOT</span> <span class="built_in">NULL</span>,</span><br><span class="line">	email VARCHAR(<span class="number">64</span>),</span><br><span class="line">	username VARCHAR(<span class="number">64</span>),</span><br><span class="line">	role_id <span class="built_in">INTEGER</span>,</span><br><span class="line">	password_hash VARCHAR(<span class="number">128</span>),</span><br><span class="line">	confirmed <span class="built_in">BOOLEAN</span>,</span><br><span class="line">	name VARCHAR(<span class="number">64</span>),</span><br><span class="line">	location VARCHAR(<span class="number">64</span>),</span><br><span class="line">	about_me TEXT,</span><br><span class="line">	member_since DATETIME,</span><br><span class="line">	last_seen DATETIME,</span><br><span class="line">	PRIMARY KEY (id),</span><br><span class="line">	FOREIGN KEY(role_id) REFERENCES roles (id),</span><br><span class="line">	CHECK (confirmed <span class="keyword">IN</span> (<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">);</span><br><span class="line">INSERT <span class="keyword">INTO</span> <span class="string">"users"</span> VALUES(<span class="number">1</span>,<span class="string">'huamingrui@163.com'</span>,<span class="string">'MrHua'</span>,<span class="number">2</span>,<span class="string">'pbkdf2:sha1:1000$tSmBVC7j$6f3d994eb5b6b455347b56d3112a4cac26fc97e1'</span>,<span class="number">1</span>,<span class="built_in">NULL</span>,<span class="built_in">NULL</span>,<span class="built_in">NULL</span>,<span class="string">'2016-05-17 14:34:36.781740'</span>,<span class="string">'2016-05-17 14:52:08.764862'</span>);</span><br><span class="line">CREATE INDEX ix_roles_default <span class="keyword">ON</span> roles (<span class="string">"default"</span>);</span><br><span class="line">CREATE UNIQUE INDEX ix_users_email <span class="keyword">ON</span> users (email);</span><br><span class="line">CREATE UNIQUE INDEX ix_users_username <span class="keyword">ON</span> users (username);</span><br><span class="line">COMMIT;</span><br><span class="line">sqlite&gt;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/13/SohuSpider/" itemprop="url">
                  SohuSpider
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-13T15:55:31+08:00" content="2016-04-13">
              2016-04-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/13/SohuSpider/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/13/SohuSpider/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h1><blockquote>
<p>请设计一个系统，自动完成对于手机搜狐(<a href="http://m.sohu.com/" target="_blank" rel="external">http://m.sohu.com/</a> )系统可靠性的检测。具体要求：  </p>
<ol>
<li>定时递归检测所有m.sohu.com域名的页面以及这些页面上的链接的可达性，即有没有出现不可访问情况。  </li>
<li>m.sohu.com域名页面很多，从各个方面考虑性能优化。  </li>
<li>对于错误的链接记录到日志中，日志包括：连接，时间，错误状态等。  </li>
<li>考虑多线程的方式实现  </li>
</ol>
<p>要求：用Python实现，不使用爬取框架，一周内回复。</p>
</blockquote>
<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>因为之前才刚刚写了一个爬虫，本以为里面的线程池拿来就能用<br>结果昨天晚上大致改了个雏形出来，发觉爬到5分钟必定卡死，改了一晚上都没有解决<br>一怒之下 Google 了一记。。。<br>搜出来两位可能是去年实习的仁兄的答案，其中一位也是用的线程池，才意识到问题应该不在这里<br>抬头一看12点了，还突然停水不能洗脚。。。草草刷个牙郁闷地滚去睡了</p>
<p>今天学习了一下二位前辈的代码，彻底重写了一个，还是卡在5分钟，实在莫名其妙<br>Google 百度 各种改来改去无果，差点绝望了   </p>
<p>后来想到，没头绪的缘由还是因为卡住的时候连个报错都没有，没有好的切入点<br>那我就多加点 logger 好了</p>
<p>这才发现，5分钟的时候提取 URL 会出现大片的<code>None</code>，在这之前有个链接是 <a href="http://m.sohu.com/f/521204/?_once_=000067_ayy" target="_blank" rel="external">http://m.sohu.com/f/521204/?_once_=000067_ayy</a><br>手动打开的话会弹窗下载 搜狐新闻 apk<br>难道是因为这个原因导致 BeautifulSoup 提取不出来 href 了？</p>
<p>另外有个意外发现。。。<br>这回看见卡住了之后没有急着顺手 kill 掉<br>结果居然等了几分钟就好了。。。跑得那叫一个顺畅。。。<br>我也不知道这算什么情况了。。。   </p>
<p>把 crontab 的自动定时加上，这样大致算是完成了吧<br>明天再看看能做什么调整</p>
<p>还有论文没看呢。。。</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p><a href="https://github.com/answerrrrrrrrr/SohuSpider/blob/master/SohuSpider.py" target="_blank" rel="external">https://github.com/answerrrrrrrrr/SohuSpider/blob/master/SohuSpider.py</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="https://github.com/zhangity/sohu_crawled/blob/master/sohu1-5.py" target="_blank" rel="external">https://github.com/zhangity/sohu_crawled/blob/master/sohu1-5.py</a></li>
<li><a href="https://github.com/lan2720/deadurl_detector/blob/master/crawl.py#L2" target="_blank" rel="external">https://github.com/lan2720/deadurl_detector/blob/master/crawl.py#L2</a></li>
<li><a href="http://honglu.me/2014/09/20/OSX%E7%B3%BB%E7%BB%9F%E6%B7%BB%E5%8A%A0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" target="_blank" rel="external">http://honglu.me/2014/09/20/OSX%E7%B3%BB%E7%BB%9F%E6%B7%BB%E5%8A%A0%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/08/Spider-07-doctest/" itemprop="url">
                  Spider-07-doctest
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-08T11:43:23+08:00" content="2016-04-08">
              2016-04-08
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/08/Spider-07-doctest/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/08/Spider-07-doctest/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第七天-doctest"><a href="#知道创宇爬虫设计第七天-doctest" class="headerlink" title="知道创宇爬虫设计第七天: doctest"></a>知道创宇爬虫设计第七天: doctest</h1><p><code>doctest</code>是 Python 内建的模块，用于文档测试，正好可以拿来用于爬虫的自测功能</p>
<p>这个模块相对简单，直接贴代码</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">''' Prepare and run the spider</span><br><span class="line">    Self-test:</span><br><span class="line">    &gt;&gt;&gt; class Args(object):</span><br><span class="line">    ...     pass</span><br><span class="line">    ...</span><br><span class="line">    &gt;&gt;&gt; args = Args()</span><br><span class="line">    &gt;&gt;&gt; args.url = 'www.baidu.com'</span><br><span class="line">    &gt;&gt;&gt; args.depth = 1</span><br><span class="line">    &gt;&gt;&gt; args.logfile = 'testself.log'</span><br><span class="line">    &gt;&gt;&gt; args.loglevel = 4</span><br><span class="line">    &gt;&gt;&gt; args.dbfile = 'testself.db'</span><br><span class="line">    &gt;&gt;&gt; args.num_threads = 1</span><br><span class="line">    &gt;&gt;&gt; args.key = ''</span><br><span class="line">    &gt;&gt;&gt; set_logger(args.loglevel, args.logfile)</span><br><span class="line">    &gt;&gt;&gt; logger.info(vars(args))</span><br><span class="line">    &gt;&gt;&gt; spider = MySpider(args)</span><br><span class="line">    &gt;&gt;&gt; spider.run()</span><br><span class="line">    '''</span></span><br><span class="line">...</span><br><span class="line">    <span class="comment"># Self test</span></span><br><span class="line">    <span class="keyword">if</span> args.testself:</span><br><span class="line">        <span class="keyword">import</span> doctest</span><br><span class="line">        <span class="keyword">print</span> doctest.testmod()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>另外其它部分也有少量修改，放在 <a href="https://github.com/answerrrrrrrrr/KnownsecSpider" target="_blank" rel="external">https://github.com/answerrrrrrrrr/KnownsecSpider</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014319170285543a4d04751f8846908770660de849f285000" target="_blank" rel="external">http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014319170285543a4d04751f8846908770660de849f285000</a></li>
<li><a href="http://devdocs.io/python~2.7/library/doctest#doctest.DocTest" target="_blank" rel="external">http://devdocs.io/python~2.7/library/doctest#doctest.DocTest</a></li>
<li><a href="http://devdocs.io/python~2.7/library/argparse#argparse.Namespace" target="_blank" rel="external">http://devdocs.io/python~2.7/library/argparse#argparse.Namespace</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/07/mysql-utf-8/" itemprop="url">
                  Mac 安装 MySQL 并设置 utf-8
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-07T22:23:29+08:00" content="2016-04-07">
              2016-04-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Mac/" itemprop="url" rel="index">
                    <span itemprop="name">Mac</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/07/mysql-utf-8/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/07/mysql-utf-8/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h1><p><a href="http://dev.mysql.com/downloads/mysql/5.6.html" target="_blank" rel="external">http://dev.mysql.com/downloads/mysql/5.6.html</a></p>
<h1 id="关闭服务"><a href="#关闭服务" class="headerlink" title="关闭服务"></a>关闭服务</h1><p><code>系统偏好设置 - MySQL - Stop MySQL Server</code></p>
<h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ vim ~/.zshrc</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"># Add mysql</span><br><span class="line">export PATH=&quot;$PATH&quot;:/usr/local/mysql/bin</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ source ~/.zshrc</span><br></pre></td></tr></table></figure>
<h1 id="设置-utf-8"><a href="#设置-utf-8" class="headerlink" title="设置 utf-8"></a>设置 utf-8</h1><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo cp /usr/local/mysql/support-files/my-default.cnf /etc/my.cnf</span><br><span class="line">$ sudo vim /etc/my.cnf</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">[client]</span><br><span class="line">default-character-set = utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">default-storage-engine = INNODB</span><br><span class="line">character-set-server = utf8</span><br><span class="line">collation-server = utf8_general_ci</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h1 id="开启服务"><a href="#开启服务" class="headerlink" title="开启服务"></a>开启服务</h1><p><code>系统偏好设置 - MySQL - Start MySQL Server</code></p>
<h1 id="验证-utf-8"><a href="#验证-utf-8" class="headerlink" title="验证 utf-8"></a>验证 utf-8</h1><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line">$ mysql -u root -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 5</span><br><span class="line">Server version: 5.6.29 MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line"><span class="section">mysql&gt; show variables like '%char%';</span><br><span class="line">+--------------------------+--------------------------------------------------------+</span></span><br><span class="line"><span class="section">| Variable_name            | Value                                                  |</span><br><span class="line">+--------------------------+--------------------------------------------------------+</span></span><br><span class="line">| character<span class="emphasis">_set_</span>client     | utf8                                                   |</span><br><span class="line">| character<span class="emphasis">_set_</span>connection | utf8                                                   |</span><br><span class="line">| character<span class="emphasis">_set_</span>database   | utf8                                                   |</span><br><span class="line">| character<span class="emphasis">_set_</span>filesystem | binary                                                 |</span><br><span class="line">| character<span class="emphasis">_set_</span>results    | utf8                                                   |</span><br><span class="line">| character<span class="emphasis">_set_</span>server     | utf8                                                   |</span><br><span class="line">| character<span class="emphasis">_set_</span>system     | utf8                                                   |</span><br><span class="line"><span class="section">| character_sets_dir       | /usr/local/mysql-5.6.29-osx10.8-x86_64/share/charsets/ |</span><br><span class="line">+--------------------------+--------------------------------------------------------+</span></span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h1 id="mysql-connector"><a href="#mysql-connector" class="headerlink" title="mysql.connector"></a>mysql.connector</h1><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">(venv3.5)$ pip3 install mysql-connector-python-rf</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014320107391860b39da6901ed41a296e574ed37104752000" target="_blank" rel="external">http://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/0014320107391860b39da6901ed41a296e574ed37104752000</a></li>
<li><a href="http://blog.csdn.net/waleking/article/details/7620983" target="_blank" rel="external">http://blog.csdn.net/waleking/article/details/7620983</a></li>
<li><a href="http://jingyan.baidu.com/article/48a42057e2b2b9a9242504a2.html" target="_blank" rel="external">http://jingyan.baidu.com/article/48a42057e2b2b9a9242504a2.html</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/07/Spider-06-requests/" itemprop="url">
                  Spider-06-requests
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-07T19:53:43+08:00" content="2016-04-07">
              2016-04-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/07/Spider-06-requests/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/07/Spider-06-requests/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第六天：requests"><a href="#知道创宇爬虫设计第六天：requests" class="headerlink" title="知道创宇爬虫设计第六天：requests"></a>知道创宇爬虫设计第六天：requests</h1><p>从实验室回学校之后，仅仅是换了个网络，却突然出现了乱码问题</p>
<p>折腾了半天编码无果，无意中发现把<code>urllib2</code>换成<code>requests</code>就好了<br>按照<code>requests</code><a href="http://www.python-requests.org/en/master/user/quickstart/" target="_blank" rel="external">官方文档</a>里的解释</p>
<blockquote>
<p>When you make a request, Requests makes educated guesses about the encoding of the response based on the HTTP headers. The text encoding guessed by Requests is used when you access r.text.</p>
</blockquote>
<p>难怪总在知乎看见人安利，确实是更好用一些啊。。。</p>
<p>具体用法也很简单方便<br>不过使用<code>request.text</code>返回结果时，标题依然会乱码</p>
<blockquote>
<p>You can also access the response body as bytes, for non-text requests</p>
</blockquote>
<p>改成使用<code>request.content</code>，果然一切正常了</p>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">            <span class="comment"># request = urllib2.Request(url, headers=headers)</span></span><br><span class="line">            <span class="comment"># result = urllib2.urlopen(request).read()</span></span><br><span class="line"></span><br><span class="line">            request = requests.get(url, headers=headers)</span><br><span class="line">            <span class="comment"># result = request.text</span></span><br><span class="line">            result = request.content</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://www.python-requests.org/en/master/" target="_blank" rel="external">http://www.python-requests.org/en/master/</a></li>
<li><a href="http://www.python-requests.org/en/master/user/quickstart/" target="_blank" rel="external">http://www.python-requests.org/en/master/user/quickstart/</a></li>
<li><a href="http://blog.csdn.net/alpha5/article/details/24964009" target="_blank" rel="external">http://blog.csdn.net/alpha5/article/details/24964009</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/06/Spider-05-Spider/" itemprop="url">
                  Spider-05-Spider
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-04-06T09:00:36+08:00" content="2016-04-06">
              2016-04-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index">
                    <span itemprop="name">Python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/06/Spider-05-Spider/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/06/Spider-05-Spider/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="知道创宇爬虫设计第五天：Spider"><a href="#知道创宇爬虫设计第五天：Spider" class="headerlink" title="知道创宇爬虫设计第五天：Spider"></a>知道创宇爬虫设计第五天：Spider</h1><p> 准备工作完成的差不多了，今天尝试下把之前的模块都整合起来做一个初期版本</p>
<p> 首先 <a href="http://stackoverflow.com/questions/4327392/what-is-the-difference-between-web-crawling-and-web-scraping" target="_blank" rel="external">What is the difference between web-crawling and web-scraping?</a><br>感觉其实这个答案比最佳答案更简洁明了  </p>
<blockquote>
<p>Web Crawling is what Google does - it goes around a website looking at links and building a database of the layout of that site and sites it links to</p>
<p>Web Scraping would be the progamatic analysis of a web page to load some data off of it, EG loading up BBC weather and ripping (scraping) the weather forcast off of it and placing it elsewhere or using it in another program.</p>
</blockquote>
<p>我的理解就是<code>web-crawling</code>在于广度，<code>web-scraping</code>在于精度</p>
<h1 id="BeautifulSoup"><a href="#BeautifulSoup" class="headerlink" title="BeautifulSoup"></a>BeautifulSoup</h1><p>为了<code>crawl</code>，需要从页面提取出用于进一步爬取的 URL ，BeautifulSoup 正好能方便快捷地完成这个任务，上手也很简单，基本上看看<a href="http://beautifulsoup.readthedocs.org/zh_CN/latest/" target="_blank" rel="external">官方文档</a>就万事大吉了</p>
<h1 id="FileHandler"><a href="#FileHandler" class="headerlink" title="FileHandler"></a>FileHandler</h1><p>在整合 logger 的时候发现一个问题，使用<code>logging.config.fileConfig(&#39;logging.conf&#39;)</code>的话，需要提前在配置文件里写定日志保存路径，为了配合参数设定其他路径，似乎（看了一下 <a href="http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler" target="_blank" rel="external">FileHandler</a> 的用法）只能额外添加一个了</p>
<figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    # <span class="keyword">If</span> logfile <span class="keyword">is</span> <span class="keyword">not</span> <span class="string">'spider.log'</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        <span class="string">'%(asctime)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    logger.addHandler(file_handler)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>目前爬虫已经基本能用，但偶尔还是会出现<code>502</code>，然后该往数据库里放些什么东西还有待考虑，另外也没有加上自测功能</p>
<figure class="highlight python"><figcaption><span>myspider.py</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> Queue <span class="keyword">import</span> Queue</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logging.config.fileConfig(<span class="string">'logging.conf'</span>)</span><br><span class="line">logger = logging.getLogger(<span class="string">'spider'</span>)</span><br><span class="line"></span><br><span class="line">levels = &#123;</span><br><span class="line">    <span class="number">1</span>: <span class="string">'CRITICAL'</span>,</span><br><span class="line">    <span class="number">2</span>: <span class="string">'ERROR'</span>,</span><br><span class="line">    <span class="number">3</span>: <span class="string">'WARNING'</span>,</span><br><span class="line">    <span class="number">4</span>: <span class="string">'INFO'</span>,</span><br><span class="line">    <span class="number">5</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySqlite</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, dbfile)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.warning(<span class="string">"Open database %s"</span> % dbfile)</span><br><span class="line">            self.conn = sqlite3.connect(dbfile)</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># print "Fail to connect %s: %s" % (dbfile, e) # e.args[0]</span></span><br><span class="line">            logger.error(<span class="string">"Fail to connect %s: %s"</span> % (dbfile, e))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, table)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.warning(<span class="string">"Create table %s if not exists"</span> % table)</span><br><span class="line">            self.cursor.execute(</span><br><span class="line">                <span class="string">"CREATE TABLE IF NOT EXISTS %s (id INTEGER PRIMARY KEY \</span><br><span class="line">                AUTOINCREMENT, url VARCHAR(100), data VARCHAR(40))"</span> % table)</span><br><span class="line">            self.conn.commit()</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(<span class="string">"Fail to create %s: %s"</span> % (table, e))</span><br><span class="line">            self.conn.rollback()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">insert</span><span class="params">(self, table, url, data)</span>:</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.warning(</span><br><span class="line">                <span class="string">"Insert (%s, %s) into table %s"</span> % (url, data, table))</span><br><span class="line">            self.cursor.execute(</span><br><span class="line">                <span class="string">"INSERT INTO %s (url, data) VALUES ('%s', '%s')"</span> %</span><br><span class="line">                (table, url, data))</span><br><span class="line">            self.conn.commit()</span><br><span class="line">        <span class="keyword">except</span> sqlite3.Error <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(</span><br><span class="line">                <span class="string">"Fail to insert (%s, %s) into %s: %s"</span> %</span><br><span class="line">                (url, data, table, e))</span><br><span class="line">            self.conn.rollback()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span><span class="params">(self)</span>:</span></span><br><span class="line">        logger.info(<span class="string">"Close database"</span>)</span><br><span class="line">        self.cursor.close()</span><br><span class="line">        self.conn.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThreadPool</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, num_threads=<span class="number">10</span>)</span>:</span></span><br><span class="line">        self.tasks = Queue(num_threads)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, num_threads+<span class="number">1</span>):</span><br><span class="line">            <span class="comment"># Initialize the pool with the number of num_threads</span></span><br><span class="line">            logger.info(<span class="string">'Initialize thread %d'</span> % i)</span><br><span class="line">            MyThread(self.tasks)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_task</span><span class="params">(self, func, *args, **kwargs)</span>:</span></span><br><span class="line">        self.tasks.put((func, args, kwargs))</span><br><span class="line">        logger.debug(<span class="string">'Add task'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_completion</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># Blocks until all items in the queue have been gotten and processed.</span></span><br><span class="line">        self.tasks.join()</span><br><span class="line">        logger.info(<span class="string">'All tasks are done'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span><span class="params">(Thread)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tasks)</span>:</span></span><br><span class="line">        Thread.__init__(self)</span><br><span class="line">        self.tasks = tasks</span><br><span class="line">        <span class="comment"># This must be set before start() is called. The entire Python program</span></span><br><span class="line">        <span class="comment"># exits when no alive non-daemon threads are left.</span></span><br><span class="line">        self.daemon = <span class="keyword">True</span></span><br><span class="line">        self.start()</span><br><span class="line">        logger.debug(<span class="string">'Thread started...'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">            <span class="comment"># Block until an item is available.</span></span><br><span class="line">            func, args, kwargs = self.tasks.get()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                logger.warning(<span class="string">'Thread is working...'</span>)</span><br><span class="line">                func(*args, **kwargs)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                logger.error(e)</span><br><span class="line">            <span class="comment"># Tells the queue that the processing on the task is complete.</span></span><br><span class="line">            self.tasks.task_done()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySpider</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, args)</span>:</span></span><br><span class="line">        <span class="string">''' Initialize the spider</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="comment"># Initialize args</span></span><br><span class="line">        self.url = args.url</span><br><span class="line">        self.depth = args.depth</span><br><span class="line">        self.logfile = args.logfile</span><br><span class="line">        self.dbfile = args.dbfile</span><br><span class="line">        self.num_threads = args.num_threads</span><br><span class="line">        self.key = args.key.lower()</span><br><span class="line">        self.selftest = args.selftest</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Store visited url</span></span><br><span class="line">        self.visited_urls = set()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Initialize threadpool</span></span><br><span class="line">        self.threadpool = MyThreadPool(self.num_threads)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="string">''' Run the spider</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.url.startswith(<span class="string">'http://'</span>):</span><br><span class="line">            self.url = <span class="string">'http://'</span> + self.url</span><br><span class="line">        logger.critical(<span class="string">'Start crawl on %s'</span> % self.url)</span><br><span class="line">        self.threadpool.add_task(self.scrape, self.url, self.depth)</span><br><span class="line">        self.threadpool.wait_completion()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">scrape</span><span class="params">(self, url, depth)</span>:</span></span><br><span class="line">        <span class="string">''' Scrape the content of page</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="comment"># Open database with dbfile</span></span><br><span class="line">        db = MySqlite(self.dbfile)</span><br><span class="line">        <span class="comment"># Create table with keyword</span></span><br><span class="line">        table = <span class="string">'none'</span> <span class="keyword">if</span> <span class="keyword">not</span> self.key <span class="keyword">else</span> self.key</span><br><span class="line">        db.create(table)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Avoid being recognized as robot</span></span><br><span class="line">        headers = &#123;</span><br><span class="line">            <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_4) \</span><br><span class="line">            AppleWebKit/537.36 (KHTML, like Gecko) \</span><br><span class="line">            Chrome/49.0.2623.110 Safari/537.36'</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Avoid repeat</span></span><br><span class="line">        <span class="keyword">if</span> url <span class="keyword">in</span> self.visited_urls:</span><br><span class="line">            logger.debug(<span class="string">'%s had been crawled'</span> % url)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.visited_urls.add(url)</span><br><span class="line">            logger.info(<span class="string">'Crawling on %s'</span> % url)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Request with headers</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            logger.warning(<span class="string">'Open %s'</span> % url)</span><br><span class="line">            request = urllib2.Request(url, headers=headers)</span><br><span class="line">            result = urllib2.urlopen(request).read()</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">            logger.error(e)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Extract the title by BeautifulSoup</span></span><br><span class="line">        soup = BeautifulSoup(result, <span class="string">"lxml"</span>)</span><br><span class="line">        title = soup.title.string</span><br><span class="line">        logger.debug(<span class="string">'title = %s'</span> % title)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Store url and title of the page with keyword into database</span></span><br><span class="line">        <span class="keyword">if</span> self.key <span class="keyword">in</span> result.lower():</span><br><span class="line">            table = <span class="string">'none'</span> <span class="keyword">if</span> <span class="keyword">not</span> self.key <span class="keyword">else</span> self.key</span><br><span class="line">            db.insert(table, url, title)</span><br><span class="line">            logger.critical(</span><br><span class="line">                <span class="string">'KEYWORD:\'%s\' - URL:\'%s\' - TITLE:\'%s\' (DEPTH:%d)'</span> %</span><br><span class="line">                (self.key, url, title, depth))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Close database after modification</span></span><br><span class="line">        db.close()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Go deeper into urls in result</span></span><br><span class="line">        self.crawl(soup, depth<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">crawl</span><span class="params">(self, soup, depth)</span>:</span></span><br><span class="line">        <span class="string">''' Crawl to new pages</span><br><span class="line">        '''</span></span><br><span class="line">        <span class="keyword">if</span> depth &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">for</span> link <span class="keyword">in</span> soup.find_all(<span class="string">'a'</span>):</span><br><span class="line">                url = link.get(<span class="string">'href'</span>)</span><br><span class="line">                <span class="comment"># scrape new url</span></span><br><span class="line">                self.threadpool.add_task(self.scrape, url, depth)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def stop(self):</span></span><br><span class="line">    <span class="comment">#     ''' Stop the spider</span></span><br><span class="line">    <span class="comment">#     '''</span></span><br><span class="line">    <span class="comment">#     logger.critical('OVER')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">args_parser</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">''' Parse the args</span><br><span class="line">    '''</span></span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line"></span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-u'</span>, <span class="string">'--url'</span>, dest=<span class="string">'url'</span>, required=<span class="keyword">True</span>,</span><br><span class="line">        help=<span class="string">'specify the URL to start crawl'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-d'</span>, <span class="string">'--depth'</span>, dest=<span class="string">'depth'</span>, default=<span class="number">1</span>, type=int,</span><br><span class="line">        help=<span class="string">'specify the depth of the spider (default: 1)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-f'</span>, <span class="string">'--file'</span>, dest=<span class="string">'logfile'</span>, default=<span class="string">'spider.log'</span>,</span><br><span class="line">        help=<span class="string">'specify the path of logfile (default: spider.log)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'-l'</span>, <span class="string">'--level'</span>, dest=<span class="string">'loglevel'</span>, default=<span class="number">5</span>, type=int,</span><br><span class="line">        choices=range(<span class="number">1</span>, <span class="number">6</span>),</span><br><span class="line">        help=<span class="string">'specify the verbose level of the log (default: 5)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--dbfile'</span>, dest=<span class="string">'dbfile'</span>, default=<span class="string">'spider.db'</span>,</span><br><span class="line">        help=<span class="string">'specify the path of sqlite dbfile (default: spider.db)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--thread'</span>, dest=<span class="string">'num_threads'</span>, default=<span class="number">10</span>, type=int,</span><br><span class="line">        help=<span class="string">'specify the size of thread pool (default: 10)'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--key'</span>, dest=<span class="string">'key'</span>, default=<span class="string">''</span>,</span><br><span class="line">        help=<span class="string">'specify the keyword (default: '</span><span class="string">')'</span></span><br><span class="line">    )</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">'--selftest'</span>, action=<span class="string">'store_true'</span>,</span><br><span class="line">        help=<span class="string">'self-test'</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">return</span> args</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_logger</span><span class="params">(loglevel, logfile)</span>:</span></span><br><span class="line">    <span class="string">''' Set the logger with loglevel and logfile</span><br><span class="line">    '''</span></span><br><span class="line">    logger.setLevel(levels[loglevel])</span><br><span class="line">    file_handler = logging.FileHandler(logfile)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If logfile is not 'spider.log'</span></span><br><span class="line">    formatter = logging.Formatter(</span><br><span class="line">        <span class="string">'%(asctime)s - %(levelname)s - %(message)s'</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    logger.addHandler(file_handler)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    args = args_parser()</span><br><span class="line">    set_logger(args.loglevel, args.logfile)</span><br><span class="line">    logger.debug(args)</span><br><span class="line"></span><br><span class="line">    spider = MySpider(args)</span><br><span class="line">    spider.run()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a href="http://beautifulsoup.readthedocs.org/zh_CN/latest/" target="_blank" rel="external">http://beautifulsoup.readthedocs.org/zh_CN/latest/</a></li>
<li><a href="http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler" target="_blank" rel="external">http://devdocs.io/python~2.7/library/logging.handlers#logging.FileHandler</a></li>
<li><a href="http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/" target="_blank" rel="external">http://dongweiming.github.io/blog/archives/pa-chong-lian-xi/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Air9" />
          <p class="site-author-name" itemprop="name">Air9</p>
          <p class="site-description motion-element" itemprop="description">なぜベストを尽くしたのか</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">35</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">72</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Air9</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"answerrrrrrrrr"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  


</body>
</html>
